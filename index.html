<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Absensi - Lengkap & Interaktif</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      body { font-family: 'Inter', sans-serif; }
      
      /* Animasi dan Styling Heatmap */
      .heatmap-cell {
          width: 26px; height: 26px;
          border-radius: 6px;
          transition: all 0.2s ease;
          position: relative;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 10px;
          font-weight: bold;
          color: rgba(255,255,255,0.9);
      }
      .heatmap-cell:hover {
          transform: scale(1.25);
          z-index: 10;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      
      /* Warna Status */
      .status-hadir { background-color: #10b981; } /* v - Hijau */
      .status-hadir-salah-lokasi { background-color: #84cc16; } /* x */
      .status-telat { background-color: #eab308; } /* t - Kuning */
      .status-telat-salah-lokasi { background-color: #ca8a04; } /* tx */
      .status-sakit { background-color: #ef4444; } /* s - Merah */
      .status-sakit-salah-lokasi { background-color: #b91c1c; } /* sx */
      .status-izin { background-color: #8b5cf6; } /* i - Ungu */
      .status-izin-salah-lokasi { background-color: #7c3aed; } /* ix */
      .status-tidak-absen { background-color: #6b7280; color: transparent; } /* a - Abu */
      .status-pulang { background-color: #3b82f6; } /* Pulang Normal - Biru */
      .status-pulang-cepat { background-color: #f97316; } /* Pulang Cepat - Oranye */
      .status-lupa { background-color: #93c5fd; } /* Lupa Absen - Biru Muda */
      .status-libur { background-color: #e5e7eb; color: #9ca3af; } /* h */
      .status-nodata { background-color: #f3f4f6; color: transparent; } 

      .loading {
          width: 24px; height: 24px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #3b82f6;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }
      
      /* Efek Hover untuk Kartu Stats */
      .stat-card {
          transition: transform 0.2s, box-shadow 0.2s;
          cursor: pointer;
      }
      .stat-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .stat-card.active-card {
          ring: 2px solid #3b82f6;
          background-color: #f0f9ff;
      }

      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <div class="container mx-auto px-4 py-6">
    
    <!-- Header Control Panel -->
    <header class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <div>
          <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
            üìä Dashboard Presensi
            <span id="current-period-badge" class="bg-blue-100 text-blue-800 text-xs px-2.5 py-0.5 rounded-full hidden">...</span>
          </h1>
          <p class="text-gray-500 text-sm mt-1">Klik kartu statistik untuk melihat detail karyawan.</p>
        </div>

        <!-- Filter Controls -->
        <div class="flex flex-wrap gap-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
          <div class="flex gap-2">
             <select id="filter-month" onchange="renderDashboard()" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-md p-2"><option value="">Bulan...</option></select>
             <select id="filter-year" onchange="renderDashboard()" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-md p-2"><option value="">Tahun...</option></select>
          </div>
          <div class="w-px bg-gray-300 mx-1"></div>
          <select id="filter-employee" onchange="renderDashboard()" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-md p-2 min-w-[150px]">
            <option value="all">Semua Tim</option>
          </select>
          <button onclick="initApp()" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
          </button>
        </div>
      </div>
    </header>

    <!-- State Loading & Error -->
    <div id="loading-state" class="text-center py-20 hidden">
      <div class="loading mx-auto mb-4"></div>
      <p class="text-gray-600 font-medium animate-pulse">Sinkronisasi Sheet...</p>
    </div>
    <div id="error-state" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 mb-8 text-center">
      <h3 class="text-red-800 font-bold text-lg mb-2">Koneksi Gagal</h3>
      <p class="text-red-600 text-sm" id="error-message"></p>
      <button onclick="initApp()" class="mt-4 text-sm text-red-700 underline">Coba Lagi</button>
    </div>

    <!-- Konten Dashboard -->
    <div id="dashboard-content" class="hidden space-y-6">
      
      <!-- Stats Cards (Grid 3x2) - KLIK UNTUK DETAIL -->
      <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Baris 1 -->
        <div class="stat-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-green-500" onclick="showDetails('hadir')">
            <p class="text-xs text-gray-500 uppercase font-bold">Hadir Tepat</p>
            <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-hadir">0</p>
            <p class="text-xs text-green-600 mt-1">Klik untuk detail</p>
        </div>
        <div class="stat-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-yellow-500" onclick="showDetails('telat')">
            <p class="text-xs text-gray-500 uppercase font-bold">Terlambat Masuk</p>
            <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-telat">0</p>
            <p class="text-xs text-yellow-600 mt-1">Klik untuk detail</p>
        </div>
        <div class="stat-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-red-500" onclick="showDetails('izin')">
            <p class="text-xs text-gray-500 uppercase font-bold">Sakit/Izin</p>
            <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-izin">0</p>
            <p class="text-xs text-red-600 mt-1">Klik untuk detail</p>
        </div>
        
        <!-- Baris 2 -->
        <div class="stat-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-orange-500" onclick="showDetails('pulangCepat')">
            <p class="text-xs text-gray-500 uppercase font-bold">Pulang Cepat (< 17:00)</p>
            <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-pulang-cepat">0</p>
            <p class="text-xs text-orange-600 mt-1">Klik untuk detail</p>
        </div>
        <div class="stat-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-blue-300" onclick="showDetails('tidakPulang')">
            <p class="text-xs text-gray-500 uppercase font-bold">Tidak Absen Pulang</p>
            <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-tidak-pulang">0</p>
            <p class="text-xs text-blue-400 mt-1">Klik untuk detail</p>
        </div>
        <div class="stat-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-gray-500" onclick="showDetails('alpa')">
            <p class="text-xs text-gray-500 uppercase font-bold">Alpa / Tanpa Ket.</p>
            <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-alpa">0</p>
            <p class="text-xs text-gray-500 mt-1">Klik untuk detail</p>
        </div>
      </div>

      <!-- [BARU] Tabel Detail Dinamis -->
      <div id="detail-list-container" class="hidden bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden animate-fade-in-down">
          <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
              <h3 class="font-bold text-gray-800" id="detail-list-title">Detail Data</h3>
              <button onclick="hideDetails()" class="text-gray-400 hover:text-red-500">
                  <span class="sr-only">Tutup</span>
                  <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
          </div>
          <div class="overflow-x-auto max-h-64 overflow-y-auto">
              <table class="w-full text-sm text-left">
                  <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                      <tr>
                          <th class="px-6 py-3">Nama Karyawan</th>
                          <th class="px-6 py-3">Tanggal</th>
                          <th class="px-6 py-3">Keterangan</th>
                      </tr>
                  </thead>
                  <tbody id="detail-list-body" class="divide-y divide-gray-100">
                      <!-- Isi tabel akan digenerate JS -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- Heatmap -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
        <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4">
          <h2 class="text-lg font-bold text-gray-800">üî• Grid Absensi Bulanan</h2>
          <div class="flex flex-wrap justify-center gap-3 text-xs text-gray-600">
             <div class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-sm mr-1"></span>Hadir</div>
             <div class="flex items-center"><span class="w-3 h-3 bg-yellow-500 rounded-sm mr-1"></span>Telat</div>
             <div class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-sm mr-1"></span>Pulang</div>
             <div class="flex items-center"><span class="w-3 h-3 bg-orange-500 rounded-sm mr-1"></span>Plg Cepat</div>
             <div class="flex items-center"><span class="w-3 h-3 bg-blue-300 rounded-sm mr-1"></span>Lupa Plg</div>
             <div class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-sm mr-1"></span>Sakit/Izin</div>
             <div class="flex items-center"><span class="w-3 h-3 bg-gray-500 rounded-sm mr-1"></span>Alpa</div>
          </div>
        </div>
        <div class="overflow-x-auto p-2"><div id="heatmap-container" class="min-w-[800px]"></div></div>
      </div>
      
      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-2">
            <h3 class="font-bold text-gray-700 mb-4">Komposisi Kedisiplinan</h3>
            <div class="h-[250px] w-full">
               <canvas id="chartComposition"></canvas>
            </div>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 class="font-bold text-gray-700 mb-4">üèÜ Top Rajin (Skor)</h3>
            <div id="top-performer-list" class="space-y-3"></div>
          </div>
      </div>
    </div>
  </div>

  <!-- Modal Drill-Down (Popup) -->
  <div id="detailModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900 bg-opacity-60 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-md border border-gray-200">
          <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex justify-between items-center">
            <h3 class="text-lg font-bold text-white" id="modal-title">Detail Aktivitas</h3>
            <button onclick="closeModal()" class="text-blue-100 hover:text-white text-2xl leading-none">&times;</button>
          </div>
          <div class="px-6 py-6 space-y-5">
            <div class="flex items-center space-x-4 border-b border-gray-100 pb-4">
               <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 font-bold text-xl border border-blue-100" id="modal-avatar">A</div>
               <div>
                  <h4 class="text-lg font-bold text-gray-900" id="modal-nama">-</h4>
                  <p class="text-sm text-gray-500" id="modal-tanggal">-</p>
               </div>
               <div class="ml-auto flex flex-col items-end">
                   <span id="modal-status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-600 mb-1">-</span>
                   <span class="text-[10px] text-gray-400 font-mono" id="modal-tipe">MASUK</span>
               </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-1">Jam Catat</p>
                    <p class="text-xl font-mono font-bold text-gray-800" id="modal-jam">--:--</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-1">Jarak Kantor</p>
                    <p class="text-sm font-medium text-gray-800 mt-1 truncate" id="modal-jarak">-</p>
                </div>
            </div>
            <a id="modal-maps-link" href="#" target="_blank" class="flex items-center justify-center w-full px-4 py-3 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors group">
              <span class="mr-2">üìç</span> Buka Lokasi di Maps
            </a>
            <div id="modal-foto-container" class="hidden">
               <p class="text-xs text-gray-500 mb-2 font-semibold">üì∑ Bukti Foto</p>
               <div class="relative aspect-[3/4] w-full bg-gray-100 rounded-lg overflow-hidden border border-gray-200 shadow-inner group">
                 <img id="modal-foto" src="" alt="Bukti" class="absolute inset-0 w-full h-full object-cover">
               </div>
            </div>
            <div id="modal-foto-error" class="hidden bg-yellow-50 p-3 rounded-lg text-xs text-yellow-700 border border-yellow-100">
               ‚ö†Ô∏è Foto tersedia (Path), bukan Link Publik.
            </div>
            <div id="modal-no-data" class="hidden text-center py-6">
                <div class="inline-block p-3 rounded-full bg-gray-100 mb-2">üö´</div>
                <p class="text-gray-500 text-sm italic">Data digital tidak ditemukan.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
      // --- KONFIGURASI ---
      const CONFIG = {
          sheetId: '1wCVC1jC6cSp5jIRUxTlDLOM-CyUNnSuTe8tegh3Y8QA', 
          sheetNames: {
              data: 'Data',
              arrayMasuk: 'Array Absen Masuk',
              arrayPulang: 'Array Absen Pulang'
          },
          jamPulangNormal: '17:00:00' // Setting Jam Pulang Standar
      };

      let rawData = { masterEmp: [], historyMasuk: [], historyPulang: [] };
      let processedData = {};
      let availablePeriods = [];
      let charts = {};
      
      // [BARU] Variable global untuk menyimpan detail per kategori
      let detailedStats = {
          hadir: [],
          telat: [],
          izin: [],
          pulangCepat: [],
          tidakPulang: [],
          alpa: []
      };

      async function initApp() {
          const loading = document.getElementById('loading-state');
          const errorDiv = document.getElementById('error-state');
          const content = document.getElementById('dashboard-content');
          
          loading.classList.remove('hidden');
          content.classList.add('hidden');
          errorDiv.classList.add('hidden');

          try {
              const [rowsData, rowsMasuk, rowsPulang] = await Promise.all([
                  fetchSheet(CONFIG.sheetNames.data),
                  fetchSheet(CONFIG.sheetNames.arrayMasuk),
                  fetchSheet(CONFIG.sheetNames.arrayPulang)
              ]);

              rawData.masterEmp = parseMasterData(rowsData);
              processedData = {}; 
              parseHistoryArray(rowsMasuk, 'Masuk');
              parseHistoryArray(rowsPulang, 'Pulang');
              populatePeriodFilters();
              
              if(availablePeriods.length > 0) {
                  document.getElementById('filter-year').value = availablePeriods[0].y;
                  document.getElementById('filter-month').value = availablePeriods[0].m;
              }

              renderDashboard();
              loading.classList.add('hidden');
              content.classList.remove('hidden');

          } catch (err) {
              console.error(err);
              loading.classList.add('hidden');
              errorDiv.classList.remove('hidden');
              document.getElementById('error-message').textContent = `Gagal memuat: ${err.message}.`;
          }
      }

      async function fetchSheet(sheetName) {
          const url = `https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}&headers=1`;
          const res = await fetch(url);
          if(!res.ok) throw new Error(`HTTP Error ${res.status}`);
          const text = await res.text();
          const json = JSON.parse(text.substr(47).slice(0, -2));
          return json.table.rows;
      }

      function parseMasterData(rows) {
          return rows.map(r => r.c[1]?.v).filter(n => n && n !== 'Nama');
      }

      function parseHistoryArray(rows, type) {
          rows.forEach(row => {
              const v = (i) => (row.c[i] && row.c[i].v !== null) ? row.c[i].v : null;
              
              const dateVal = v(2);
              const name = v(5);
              const code = v(14); // Index 14 = 'ico'
              
              if (!dateVal || !name || name === 'Nama' || !code) return; 

              let year, month, day;
              if (typeof dateVal === 'string' && dateVal.includes('-')) {
                  const parts = dateVal.split('-');
                  year = parseInt(parts[0]);
                  month = parseInt(parts[1]);
                  day = parseInt(parts[2]);
              } else if (String(dateVal).includes('Date')) {
                  const d = eval(`new ${dateVal}`);
                  year = d.getFullYear();
                  month = d.getMonth() + 1;
                  day = d.getDate();
              } else {
                  return;
              }

              if(!processedData[year]) processedData[year] = {};
              if(!processedData[year][month]) processedData[year][month] = {};
              if(!processedData[year][month][name]) processedData[year][month][name] = {};
              if(!processedData[year][month][name][day]) processedData[year][month][name][day] = { masuk: null, pulang: null };

              const dataObj = {
                  code: code,
                  time: v(3), // Jam (String "17:00:42")
                  loc: v(9),
                  photo: v(10),
                  jarak: v(11)
              };

              if(type === 'Masuk') processedData[year][month][name][day].masuk = dataObj;
              else processedData[year][month][name][day].pulang = dataObj;
          });
      }

      function populatePeriodFilters() {
          const years = Object.keys(processedData).sort((a,b) => b-a);
          availablePeriods = [];
          const selYear = document.getElementById('filter-year');
          const selMonth = document.getElementById('filter-month');
          selYear.innerHTML = ''; selMonth.innerHTML = '';

          if(years.length === 0) years.push(new Date().getFullYear());
          
          years.forEach(y => {
              const opt = document.createElement('option');
              opt.value = y; opt.text = y;
              selYear.appendChild(opt);
              if(processedData[y]) {
                  Object.keys(processedData[y]).forEach(m => availablePeriods.push({y:y, m:parseInt(m)}));
              }
          });
          availablePeriods.sort((a,b) => (b.y - a.y) || (b.m - a.m));
          
          const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
          monthNames.forEach((name, idx) => {
              const opt = document.createElement('option');
              opt.value = idx + 1; opt.text = name;
              selMonth.appendChild(opt);
          });
      }

      function renderDashboard() {
          const year = parseInt(document.getElementById('filter-year').value);
          const month = parseInt(document.getElementById('filter-month').value);
          const filterEmp = document.getElementById('filter-employee').value;

          const monthName = document.getElementById('filter-month').options[document.getElementById('filter-month').selectedIndex]?.text || '-';
          const badge = document.getElementById('current-period-badge');
          badge.textContent = `${monthName} ${year}`;
          badge.classList.remove('hidden');

          const gridData = [];
          const daysInMonth = new Date(year, month, 0).getDate();
          const allEmployees = [...rawData.masterEmp];
          
          if(processedData[year] && processedData[year][month]) {
              Object.keys(processedData[year][month]).forEach(n => {
                  if(!allEmployees.includes(n)) allEmployees.push(n);
              });
          }
          allEmployees.sort();

          const empSel = document.getElementById('filter-employee');
          if(empSel.options.length <= 1) {
              allEmployees.forEach(n => {
                   const opt = document.createElement('option');
                   opt.value = n; opt.text = n;
                   empSel.appendChild(opt);
              });
          }

          allEmployees.forEach(name => {
              if (filterEmp !== 'all' && name !== filterEmp) return;
              const empRow = { nama: name, days: [] };

              for(let d=1; d<=daysInMonth; d++) {
                  let dataHarian = { masuk: null, pulang: null };
                  if(processedData[year] && processedData[year][month] && processedData[year][month][name] && processedData[year][month][name][d]) {
                      dataHarian = processedData[year][month][name][d];
                  }

                  let mCode = dataHarian.masuk ? dataHarian.masuk.code : '';
                  let pCode = dataHarian.pulang ? dataHarian.pulang.code : '';

                  if(!mCode && !pCode) {
                      const checkDate = new Date(year, month-1, d);
                      const today = new Date();
                      if(checkDate < today) mCode = 'a';
                  }

                  empRow.days.push({
                      day: d,
                      masuk: { ...dataHarian.masuk, code: mCode },
                      pulang: { ...dataHarian.pulang, code: pCode }
                  });
              }
              gridData.push(empRow);
          });

          renderHeatmap(gridData, daysInMonth);
          calculateAndRenderStats(gridData, daysInMonth);
          
          // Sembunyikan tabel detail saat render ulang (ganti bulan/filter)
          hideDetails();
      }

      function renderHeatmap(data, daysCount) {
          const container = document.getElementById('heatmap-container');
          let html = '<table class="w-full border-collapse text-xs">';
          html += '<thead><tr class="bg-gray-50 border-b border-gray-200">';
          html += '<th class="p-3 text-left font-semibold text-gray-600 sticky left-0 bg-gray-50 z-20 shadow-sm min-w-[150px]">Nama Karyawan</th>';
          for(let i=1; i<=daysCount; i++) html += `<th colspan="2" class="p-1 text-center font-medium text-gray-400 border-l border-gray-100">${i}</th>`;
          html += '</tr></thead><tbody>';

          data.forEach(emp => {
              html += `<tr class="hover:bg-blue-50/30 border-b border-gray-100 transition-colors">`;
              html += `<td class="p-3 font-medium text-gray-700 sticky left-0 bg-white z-10 shadow-sm whitespace-nowrap">${emp.nama}</td>`;
              
              emp.days.forEach(d => {
                  const m = d.masuk; 
                  const p = d.pulang; 
                  
                  const cM = getStatusClass(m.code, 'Masuk');
                  const cP = getStatusClass(p.code, 'Pulang', m.code, p.time);
                  
                  html += `<td class="p-1 border-l border-gray-100"><div onclick="openModal('${emp.nama}', ${d.day}, '${m.code||''}', 'Masuk', '${m.time||''}', '${m.loc||''}', '${m.photo||''}', '${m.jarak||''}')" class="heatmap-cell mx-auto ${cM}" title="Masuk: ${m.code || '-'}">${m.code ? m.code.toUpperCase() : ''}</div></td>`;
                  html += `<td class="p-1 border-r border-gray-100"><div onclick="openModal('${emp.nama}', ${d.day}, '${p.code||''}', 'Pulang', '${p.time||''}', '${p.loc||''}', '${p.photo||''}', '${p.jarak||''}')" class="heatmap-cell mx-auto ${cP}" title="Pulang: ${p.code || '-'}">${p.code === 'v' ? 'P' : (p.code ? p.code.toUpperCase() : '')}</div></td>`;
              });
              html += '</tr>';
          });
          html += '</tbody></table>';
          container.innerHTML = html;
      }

      function calculateAndRenderStats(data, daysCount) {
          let s = { 
            hadir: 0, telat: 0, izin: 0, alpa: 0, 
            pulangCepat: 0, tidakPulang: 0 
          };
          
          // [BARU] Reset detail setiap kali kalkulasi ulang
          detailedStats = {
              hadir: [], telat: [], izin: [], pulangCepat: [], tidakPulang: [], alpa: []
          };
          
          let scores = [];

          data.forEach(emp => {
              let score = 0;
              emp.days.forEach((d) => {
                  const c = d.masuk.code;
                  const cP = d.pulang.code;
                  const tP = d.pulang.time;
                  const tM = d.masuk.time; // Jam masuk

                  // 1. Stats Masuk & Detail
                  if(['v','x'].includes(c)) {
                      s.hadir++;
                      detailedStats.hadir.push({name: emp.nama, date: d.day, desc: `Masuk: ${tM || '-'}`});
                  }
                  if(['t','tx'].includes(c)) {
                      s.telat++;
                      detailedStats.telat.push({name: emp.nama, date: d.day, desc: `Telat Masuk: ${tM || '-'}`});
                  }
                  if(['s','sx','i','ix'].includes(c)) {
                      s.izin++;
                      detailedStats.izin.push({name: emp.nama, date: d.day, desc: `Status: ${c.toUpperCase()}`});
                  }
                  if(c === 'a') {
                      s.alpa++;
                      detailedStats.alpa.push({name: emp.nama, date: d.day, desc: 'Tidak Ada Keterangan'});
                  }

                  // 2. Stats Pulang (Logic Baru) & Detail
                  if( (c === 'v' || c === 't' || c === 'x' || c === 'tx') && (!cP || cP === 'a') ) {
                      s.tidakPulang++;
                      detailedStats.tidakPulang.push({name: emp.nama, date: d.day, desc: 'Lupa/Tidak Absen Pulang'});
                      score -= 2; 
                  }

                  if(cP && tP && tP < CONFIG.jamPulangNormal) {
                      s.pulangCepat++;
                      detailedStats.pulangCepat.push({name: emp.nama, date: d.day, desc: `Pulang: ${tP}`});
                      score -= 1;
                  }

                  // 3. Scoring General
                  if(c === 'v') score += 10;
                  else if(c === 'x') score += 8;
                  else if(c === 't') score += 5;
                  else if(c === 'a') score -= 5;
              });
              scores.push({name: emp.nama, score: score});
          });

          // Render Angka
          document.getElementById('stat-hadir').innerText = s.hadir;
          document.getElementById('stat-telat').innerText = s.telat;
          document.getElementById('stat-izin').innerText = s.izin;
          document.getElementById('stat-alpa').innerText = s.alpa;
          document.getElementById('stat-pulang-cepat').innerText = s.pulangCepat;
          document.getElementById('stat-tidak-pulang').innerText = s.tidakPulang;

          renderCompositionChart(s);

          scores.sort((a,b) => b.score - a.score);
          const list = document.getElementById('top-performer-list');
          list.innerHTML = scores.slice(0,5).map((x, i) => `
              <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100">
                  <div class="flex items-center gap-3"><span class="w-6 h-6 flex items-center justify-center ${i<3?'bg-yellow-500':'bg-gray-400'} text-white rounded-full text-xs font-bold shadow-sm">${i+1}</span><span class="font-medium text-gray-700">${x.name}</span></div>
                  <span class="text-sm font-bold text-blue-600">${x.score} Pts</span>
              </div>
          `).join('');
      }
      
      // [BARU] Fungsi Tampilkan Detail
      window.showDetails = function(category) {
          const container = document.getElementById('detail-list-container');
          const tbody = document.getElementById('detail-list-body');
          const title = document.getElementById('detail-list-title');
          
          // Reset style active card
          document.querySelectorAll('.stat-card').forEach(el => el.classList.remove('active-card'));
          
          let dataList = detailedStats[category] || [];
          let categoryName = '';
          
          switch(category) {
              case 'hadir': categoryName = 'Hadir Tepat Waktu'; break;
              case 'telat': categoryName = 'Keterlambatan Masuk'; break;
              case 'izin': categoryName = 'Sakit & Izin'; break;
              case 'pulangCepat': categoryName = 'Pulang Lebih Awal'; break;
              case 'tidakPulang': categoryName = 'Tidak Absen Pulang'; break;
              case 'alpa': categoryName = 'Alpa (Tanpa Keterangan)'; break;
          }
          
          title.textContent = `Detail: ${categoryName} (${dataList.length})`;
          tbody.innerHTML = '';
          
          if(dataList.length === 0) {
              tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500 italic">Tidak ada data untuk kategori ini.</td></tr>';
          } else {
              // Sort berdasarkan tanggal
              dataList.sort((a, b) => a.date - b.date);
              
              const monthName = document.getElementById('filter-month').options[document.getElementById('filter-month').selectedIndex].text;
              const year = document.getElementById('filter-year').value;

              dataList.forEach(item => {
                  const tr = document.createElement('tr');
                  tr.className = 'bg-white border-b hover:bg-gray-50';
                  tr.innerHTML = `
                      <td class="px-6 py-3 font-medium text-gray-900">${item.name}</td>
                      <td class="px-6 py-3">${item.date} ${monthName} ${year}</td>
                      <td class="px-6 py-3 text-gray-600">${item.desc}</td>
                  `;
                  tbody.appendChild(tr);
              });
          }
          
          container.classList.remove('hidden');
          // Highlight card clicked (optional logic could be added here to target specific card)
      };
      
      window.hideDetails = function() {
          document.getElementById('detail-list-container').classList.add('hidden');
          document.querySelectorAll('.stat-card').forEach(el => el.classList.remove('active-card'));
      };

      function getStatusClass(c, type, pairCode, time) {
          if(!c) {
              if(type === 'Pulang' && pairCode && pairCode !== 'a' && pairCode !== 'h' && !c) return 'status-lupa'; 
              return 'status-nodata';
          }
          c = c.toLowerCase();
          
          if(type === 'Pulang') {
              if(time && time < CONFIG.jamPulangNormal) return 'status-pulang-cepat';
              if(c === 'v') return 'status-pulang';
              if(c === 'a') return 'status-tidak-absen';
              return 'status-nodata';
          }
          
          if(c === 'v') return 'status-hadir';
          if(c === 'x') return 'status-hadir-salah-lokasi';
          if(c === 't') return 'status-telat';
          if(c === 'tx') return 'status-telat-salah-lokasi';
          if(c.startsWith('s')) return 'status-sakit';
          if(c.startsWith('i')) return 'status-izin';
          if(c === 'a') return 'status-tidak-absen';
          if(c === 'h') return 'status-libur';
          return 'status-nodata';
      }

      function renderCompositionChart(stats) {
          const ctx = document.getElementById('chartComposition').getContext('2d');
          if(charts.composition) charts.composition.destroy();

          charts.composition = new Chart(ctx, {
              type: 'doughnut',
              data: {
                  labels: ['Hadir', 'Telat', 'Plg Cepat', 'Tdk Absen Plg', 'Sakit/Izin', 'Alpa'],
                  datasets: [{
                      data: [stats.hadir, stats.telat, stats.pulangCepat, stats.tidakPulang, stats.izin, stats.alpa],
                      backgroundColor: [
                          '#10b981', // Hadir
                          '#eab308', // Telat
                          '#f97316', // Plg Cepat
                          '#93c5fd', // Lupa Plg
                          '#ef4444', // Sakit
                          '#6b7280'  // Alpa
                      ],
                      borderWidth: 0
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: { position: 'right', labels: { boxWidth: 12, padding: 10, font: {size: 10} } }
                  },
                  cutout: '60%'
              }
          });
      }

      // Modal Functions (Sama seperti sebelumnya)
      window.openModal = function(nama, hari, code, type, jam, loc, foto, jarak) {
          const modal = document.getElementById('detailModal');
          const monthName = document.getElementById('filter-month').options[document.getElementById('filter-month').selectedIndex].text;
          const year = document.getElementById('filter-year').value;
          document.getElementById('modal-nama').innerText = nama;
          document.getElementById('modal-avatar').innerText = nama.charAt(0).toUpperCase();
          document.getElementById('modal-tanggal').innerText = `${hari} ${monthName} ${year}`;
          document.getElementById('modal-tipe').innerText = type.toUpperCase();
          document.getElementById('modal-status-badge').innerText = code ? `Kode: ${code.toUpperCase()}` : 'Tidak Ada Data';
          const elJam = document.getElementById('modal-jam');
          const elJarak = document.getElementById('modal-jarak');
          const elMaps = document.getElementById('modal-maps-link');
          const elFotoContainer = document.getElementById('modal-foto-container');
          const elFotoError = document.getElementById('modal-foto-error');
          const elImg = document.getElementById('modal-foto');
          const elNoData = document.getElementById('modal-no-data');

          const isValid = (val) => val && val !== 'null' && val !== 'undefined';
          const hasData = isValid(jam) || isValid(loc);

          if(hasData) {
              elNoData.classList.add('hidden');
              elJam.innerText = isValid(jam) ? jam.substring(0,5) : '--:--';
              elJarak.innerText = isValid(jarak) ? `${jarak} km` : '-';
              if(isValid(loc)) {
                  const cleanLoc = loc.replace(/["]/g, '');
                  elMaps.href = `https://www.google.com/maps/search/?api=1&query=${cleanLoc}`;
                  elMaps.classList.remove('hidden');
              } else { elMaps.classList.add('hidden'); }
              if(isValid(foto)) {
                  if (foto.startsWith('http')) { elFotoContainer.classList.remove('hidden'); elFotoError.classList.add('hidden'); elImg.src = foto; }
                  else if (foto.includes('/') && !foto.startsWith('http')) { elFotoContainer.classList.add('hidden'); elFotoError.classList.remove('hidden'); }
                  else { elFotoContainer.classList.remove('hidden'); elFotoError.classList.add('hidden'); elImg.src = `https://drive.google.com/thumbnail?id=${foto}`; }
              } else { elFotoContainer.classList.add('hidden'); elFotoError.classList.add('hidden'); }
          } else {
              elJam.innerText = '--:--'; elJarak.innerText = '-';
              elMaps.classList.add('hidden'); elFotoContainer.classList.add('hidden'); elFotoError.classList.add('hidden');
              elNoData.classList.remove('hidden');
          }
          modal.classList.remove('hidden');
      };
      window.closeModal = function() { document.getElementById('detailModal').classList.add('hidden'); };
      document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
