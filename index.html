<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Absensi Google Sheet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      body {
          font-family: 'Inter', sans-serif;
          box-sizing: border-box;
      }
      .metric-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .metric-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      }
      .heatmap-cell {
          width: 20px; /* Diperkecil dari 25px */
          height: 20px; /* Diperkecil dari 25px */
          border-radius: 4px;
          transition: all 0.2s ease;
          position: relative;
      }
      .heatmap-cell:hover {
          transform: scale(1.2);
          z-index: 10;
      }
      
      /* Definisi Status
        v = Hadir Tepat (Hadir, Lokasi Benar)
        x = Hadir Salah Lokasi (Hadir, Lokasi Salah)
        t = Telat Tepat (Telat, Lokasi Benar)
        tx = Telat Salah Lokasi (Telat, Lokasi Salah)
        s = Sakit (dengan lampiran, dianggap lokasi benar)
        sx = Sakit (tanpa lampiran, dianggap lokasi salah)
        i = Izin (dengan lampiran, dianggap lokasi benar)
        ix = Izin (tanpa lampiran, dianggap lokasi salah)
        a = Tidak Absen (Alpa)
      */

      /* Hadir */
      .status-hadir { background-color: #10b981; } /* v */
      .status-hadir-salah-lokasi { background-color: #84cc16; } /* x */
      
      /* Telat */
      .status-telat { background-color: #f59e0b; } /* t */
      .status-telat-salah-lokasi { background-color: #fb923c; } /* tx */

      /* Sakit */
      .status-sakit { background-color: #ef4444; } /* s */
      .status-sakit-salah-lokasi { background-color: #f87171; } /* sx */

      /* Izin */
      .status-izin { background-color: #8b5cf6; } /* i */
      .status-izin-salah-lokasi { background-color: #a78bfa; } /* ix */

      /* Tidak Absen */
      .status-tidak-absen { background-color: #6b7280; } /* a */
      
      /* Pulang */
      .status-pulang { background-color: #60a5fa; } /* v (Pulang) */
      
      .loading {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #3498db;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      /* Style untuk font Inter */
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 sm:px-6 py-8">
    
    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-2" id="dashboard-title">Dashboard Absensi Karyawan</h1>
      <p class="text-gray-600" id="company-subtitle">Data Real-time dari Google Sheet</p>
    </header>
    
    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
      <div class="loading mx-auto mb-4"></div>
      <p class="text-gray-600">Memuat data dari Google Sheet...</p>
    </div>
    
    <!-- Error State -->
    <div id="error-state" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 mb-8">
      <div class="flex items-center">
        <div class="text-red-500 text-3xl mr-4">‚ö†Ô∏è</div>
        <div>
          <h3 class="text-red-800 font-semibold text-lg">Gagal Memuat Data</h3>
          <p class="text-red-600" id="error-message">Tidak dapat mengakses Google Sheet. Pastikan sheet dapat diakses publik.</p>
        </div>
      </div>
    </div>
    
    <!-- Main Dashboard Content -->
    <div id="dashboard-content" class="hidden">
      
      <!-- [BARU] Analisis & Filter -->
      <section class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">üîç Analisis & Filter</h2>
        
        <!-- Filter Dropdown -->
        <div class="mb-6 bg-white p-6 rounded-xl shadow-lg">
          <label for="employee-filter" class="block text-lg font-semibold text-gray-800 mb-3">Filter Karyawan (Deep Dive)</label>
          <p class="text-gray-600 mb-4 text-sm">Pilih karyawan untuk melihat data spesifik mereka di semua modul di bawah ini.</p>
          <select id="employee-filter" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="all">Semua Karyawan</option>
            <!-- Opsi akan diisi oleh JavaScript -->
          </select>
        </div>

        <!-- Grafik Baru -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Grafik Tren Keterlambatan Harian -->
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìà Tren Keterlambatan Harian</h3>
            <canvas id="chartLateTrend" height="200"></canvas>
          </div>
          
          <!-- Grafik Akurasi Lokasi -->
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">üéØ Akurasi Lokasi Absensi</h3>
            <canvas id="chartLocation" height="200"></canvas>
          </div>

          <!-- [BARU] Grafik Tren Tidak Absen -->
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">üö´ Tren Tidak Absen (Alpa)</h3>
            <canvas id="chartAbsentTrend" height="200"></canvas>
          </div>
        </div>
      </section>

      <!-- Daftar Karyawan -->
      <section class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">üë• Performa Karyawan</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          
          <!-- Top Performer -->
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><span class="text-green-500 mr-2 text-2xl">‚≠ê</span> Top 5 Karyawan Terbaik</h3>
            <div class="space-y-3" id="top-performer">
              <!-- Data akan diisi oleh JavaScript -->
            </div>
          </div>
          
          <!-- Perlu Perhatian -->
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><span class="text-red-500 mr-2 text-2xl">‚ö†Ô∏è</span> 5 Karyawan Perlu Perhatian</h3>
            <div class="space-y-3" id="need-attention">
              <!-- Data akan diisi oleh JavaScript -->
            </div>
          </div>
          
        </div>
      </section>
      
      <!-- Peta Panas Kehadiran -->
      <section class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">üî• Peta Panas Kehadiran</h2>
        <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
          
          <!-- Legenda Heatmap -->
          <div class="mb-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 text-sm">
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-hadir"></div><span>Hadir</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-hadir-salah-lokasi"></div><span>Hadir (Salah Lokasi)</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-telat"></div><span>Telat</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-telat-salah-lokasi"></div><span>Telat (Salah Lokasi)</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-sakit"></div><span>Sakit</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-izin"></div><span>Izin</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-tidak-absen"></div><span>Tidak Absen</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-pulang"></div><span>Pulang</span></div>
          </div>
          
          <div id="heatmap-container">
            <!-- Heatmap akan diisi oleh JavaScript -->
          </div>
          
        </div>
      </section>
      
    </div>
  </div>
  
  <script>
      // --- KONFIGURASI ---
      const defaultConfig = {
          // ID Google Sheet Anda sudah terpasang di sini
          sheet_id: '1wCVC1jC6cSp5jIRUxTlDLOM-CyUNnSuTe8tegh3Y8QA',
          // Nama sheet (tab) yang berisi data
          sheet_name: 'Laporan',
          // Judul Dashboard
          company_name: 'Dashboard Absensi Karyawan'
      };

      // --- Variabel Global ---
      let currentData = null; // Menyimpan data *penuh* dari Google Sheet
      let charts = {}; // Menyimpan semua instance Chart.js

      // Fungsi untuk mengambil data dari Google Sheet
      async function fetchSheetData(sheetId, sheetName) {
          try {
              // Menambahkan parameter cache buster unik (_=timestamp) untuk memastikan data selalu baru
              const cacheBuster = `&_=${new Date().getTime()}`;
              // Menggunakan endpoint gviz/tq untuk mendapatkan JSON
              // Menambahkan &headers=0 untuk memaksa API mengembalikan semua barj, tanpa menebak header
              const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}&headers=0${cacheBuster}`;
              const response = await fetch(url);
              
              if (!response.ok) {
                  throw new Error(`Google Sheet merespon dengan status: ${response.status}`);
              }
              
              const text = await response.text();
              
              // Membersihkan response JSONP dari Google
              const jsonText = text.substring(47).slice(0, -2);
              const data = JSON.parse(jsonText);
              
              if (data.status === 'error') {
                  throw new Error(`Error dari Google Sheet API: ${data.errors.map(e => e.detailed_message).join(', ')}`);
              }

              return parseSheetData(data);
          } catch (error) {
              console.error('Error fetching sheet data:', error);
                  throw new Error(`Gagal mengambil data. Pastikan Google Sheet Anda sudah di "Publish to the web" dan nama sheet ("${sheetName}") sudah benar.`);
          }
      }

      // Parse data dari Google Sheet
      function parseSheetData(data) {
          const rows = data.table.rows;
          const employees = [];
          
          if (!rows || rows.length < 2) {
              throw new Error("Data tidak ditemukan atau format sheet salah. Pastikan baris pertama adalah header.");
          }

          // Skip header row (i = 0), mulai dari data (i = 1)
          // Berdasarkan gambar Anda, data karyawan mulai dari baris 6 (index 5)
          for (let i = 5; i < rows.length; i++) {
              const row = rows[i];
              // Pastikan baris dan kolom nama ada (Kolom A, index 0)
              if (!row.c || !row.c[0] || typeof row.c[0].v !== 'string' || row.c[0].v.trim() === '') {
                  continue; // Lewati baris jika tidak ada nama
              }
              
              const employee = {
                  nama: row.c[0].v.trim(),
                  absenMasuk: [],
                  absenPulang: []
              };
              
              // Parse absen masuk (Kolom D, F, H, ... | index 1, 3, 5, ... setelah null di-skip)
              // Kita melompat (j += 2) untuk melewati kolom "Pulang"
              // Loop diubah dari (j=3; j<=63) menjadi (j=1; j<=61) untuk memperbaiki pergeseran 2-kolom
              for (let j = 1; j <= 61; j += 2) {
                  let status = (row.c[j] && row.c[j].v) ? String(row.c[j].v).toLowerCase().trim() : '';
                  employee.absenMasuk.push(status);
              }
              
              // Parse absen pulang (Kolom E, G, I, ... | index 2, 4, 6, ... setelah null di-skip)
              // Kita melompat (j += 2) untuk melewati kolom "Masuk"
              // Loop diubah dari (j=4; j<=64) menjadi (j=2; j<=62) untuk memperbaiki pergeseran 2-kolom
              for (let j = 2; j <= 62; j += 2) {
                  let status = (row.c[j] && row.c[j].v) ? String(row.c[j].v).toLowerCase().trim() : '';
                  employee.absenPulang.push(status);
              }
              
              employees.push(employee);
          }
          
          if (employees.length === 0) {
              throw new Error("Tidak ada data karyawan yang valid ditemukan di sheet.");
          }
          
          return employees;
      }

      // Analisis data absensi
      function analyzeData(employees) {
          const stats = {
              totalHadir: 0,
              totalTelat: 0,
              totalSakit: 0,
              totalIzin: 0,
              totalTidakAbsen: 0,
              totalLokasiBenar: 0,
              totalLokasiSalah: 0,
              dailyLateTrend: Array(31).fill(0), // [BARU] Untuk tren keterlambatan
              dailyAbsentTrend: Array(31).fill(0), // [BARU] Untuk tren tidak absen (Alpa)
              employeeStats: {}
          };

          employees.forEach(emp => {
              stats.employeeStats[emp.nama] = {
                  hadir: 0, telat: 0, sakit: 0, izin: 0, tidakAbsen: 0,
                  lokasiBenar: 0, lokasiSalah: 0, score: 0
              };

              // Kita hanya menganalisis 'absenMasuk' (kolom B-AF) untuk statistik utama
              emp.absenMasuk.forEach((status, day) => {
                  if (!status || status === 'h') return; // 'h' adalah hari libur, diabaikan
                  
                  const empStat = stats.employeeStats[emp.nama];
                  const statusMasuk = status || ''; // Ambil status masuk
                  const statusPulang = emp.absenPulang[day] || ''; // Ambil status pulang untuk hari yang sama
                  
                  switch (statusMasuk) {
                      case 'v': // Hadir Tepat
                          stats.totalHadir++;
                          empStat.hadir++;
                          stats.totalLokasiBenar++;
                          empStat.lokasiBenar++;
                          empStat.score += 10;
                          break;
                      case 'x': // Hadir Salah Lokasi
                          stats.totalHadir++;
                          empStat.hadir++;
                          stats.totalLokasiSalah++;
                          empStat.lokasiSalah++;
                          empStat.score += 7; // Skor lebih rendah
                          break;
                      case 't': // Telat Tepat
                          stats.totalTelat++;
                          empStat.telat++;
                          stats.totalLokasiBenar++;
                          empStat.lokasiBenar++;
                          empStat.score += 5; // Skor lebih rendah
                          stats.dailyLateTrend[day]++; // [BARU] Tambahkan ke tren
                          break;
                      case 'tx': // Telat Salah Lokasi
                          stats.totalTelat++;
                          empStat.telat++;
                          stats.totalLokasiSalah++;
                          empStat.lokasiSalah++;
                          empStat.score += 3; // Skor sangat rendah
                          stats.dailyLateTrend[day]++; // [BARU] Tambahkan ke tren
                          break;
                      case 's': // Sakit (dianggap lokasi benar)
                          stats.totalSakit++;
                          empStat.sakit++;
                          stats.totalLokasiBenar++;
                          empStat.lokasiBenar++;
                          empStat.score += 2; // Skor netral
                          break;
                      case 'sx': // Sakit (salah lokasi/tanpa surat)
                          stats.totalSakit++;
                          empStat.sakit++;
                          stats.totalLokasiSalah++;
                          empStat.lokasiSalah++;
                          empStat.score += 1; // Skor rendah
                          break;
                      case 'i': // Izin (dianggap lokasi benar)
                          stats.totalIzin++;
                          empStat.izin++;
                          stats.totalLokasiBenar++;
                          empStat.lokasiBenar++;
                          empStat.score += 2; // Skor netral
                          break;
                      case 'ix': // Izin (salah lokasi/tanpa surat)
                          stats.totalIzin++;
                          empStat.izin++;
                          stats.totalLokasiSalah++;
                          empStat.lokasiSalah++;
                          empStat.score += 1; // Skor rendah
                          break;
                      case 'a': // Alpa / Tidak Absen
                      case '': // String kosong juga dihitung sebagai Tidak Absen
                          
                          // --- LOGIKA BARU ---
                          // Hanya hitung "Tidak Absen" (Alpa) jika KEDUA kolom (Masuk & Pulang) kosong.
                          if ((statusMasuk === 'a' || statusMasuk === '') && (statusPulang === 'a' || statusPulang === '')) {
                              stats.totalTidakAbsen++;
                              empStat.tidakAbsen++;
                              stats.dailyAbsentTrend[day]++; // [BARU] Tambahkan ke tren Alpa
                              empStat.score -= 5; // Skor minus
                          }
                          // Jika hanya 1 kolom yang kosong (lupa absen), tidak dihitung sebagai alpa.
                          
                          break;
                  }
              });
          });

          return stats;
      }

      // [BARU] Buat grafik tren keterlambatan
      function createLateTrendChart(stats) {
          if (charts.late) charts.late.destroy(); // Hancurkan chart lama
          
          const ctx = document.getElementById('chartLateTrend').getContext('2d');
          const labels = Array.from({ length: 31 }, (_, i) => i + 1); // Label 1-31
          
          charts.late = new Chart(ctx, {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Total Keterlambatan',
                      data: stats.dailyLateTrend,
                      backgroundColor: 'rgba(245, 158, 11, 0.2)',
                      borderColor: 'rgba(245, 158, 11, 1)',
                      borderWidth: 2,
                      tension: 0.3,
                      fill: true,
                      pointBackgroundColor: 'rgba(245, 158, 11, 1)'
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      legend: { display: false }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: {
                              stepSize: 1
                          }
                      }
                  }
              }
          });
      }

      // [BARU] Buat grafik lokasi
      function createLocationChart(stats) {
          if (charts.location) charts.location.destroy(); // Hancurkan chart lama

          const ctx = document.getElementById('chartLocation').getContext('2d');
          const total = stats.totalLokasiBenar + stats.totalLokasiSalah;
          
          charts.location = new Chart(ctx, {
              type: 'doughnut',
              data: {
                  labels: ['Lokasi Benar', 'Lokasi Salah'],
                  datasets: [{
                      data: [stats.totalLokasiBenar, stats.totalLokasiSalah],
                      backgroundColor: ['#10b981', '#ef4444'],
                      borderColor: '#ffffff',
                      borderWidth: 2
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      legend: {
                          position: 'bottom'
                      },
                      tooltip: {
                          callbacks: {
                              label: function(context) {
                                  let label = context.label || '';
                                  if (label) label += ': ';
                                  if (context.parsed) {
                                      const percentage = (context.parsed / total * 100).toFixed(1);
                                      label += `${context.parsed} (${percentage}%)`;
                                  }
                                  return label;
                              }
                          }
                      }
                  }
              }
          });
      }

      // [BARU] Buat grafik tren tidak absen (Alpa)
      function createAbsentTrendChart(stats) {
          if (charts.absent) charts.absent.destroy(); // Hancurkan chart lama
          
          const ctx = document.getElementById('chartAbsentTrend').getContext('2d');
          const labels = Array.from({ length: 31 }, (_, i) => i + 1); // Label 1-31
          
          charts.absent = new Chart(ctx, {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Total Tidak Absen (Alpa)',
                      data: stats.dailyAbsentTrend,
                      backgroundColor: 'rgba(239, 68, 68, 0.2)', // Warna merah
                      borderColor: 'rgba(239, 68, 68, 1)',
                      borderWidth: 2,
                      tension: 0.3,
                      fill: true,
                      pointBackgroundColor: 'rgba(239, 68, 68, 1)'
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      legend: { display: false }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          ticks: {
                              stepSize: 1
                          }
                      }
                  }
              }
          });
      }

      // Buat daftar top performer
      function createTopLists(stats) {
          // Top 5 performer
          const topPerformers = Object.keys(stats.employeeStats)
              .map(nama => ({
                  nama,
                  score: stats.employeeStats[nama].score,
                  hadir: stats.employeeStats[nama].hadir,
                  telat: stats.employeeStats[nama].telat,
                  sakit: stats.employeeStats[nama].sakit,
                  izin: stats.employeeStats[nama].izin,
                  tidakAbsen: stats.employeeStats[nama].tidakAbsen
              }))
              .sort((a, b) => b.score - a.score) // Urutkan dari skor tertinggi
              .slice(0, 5);

          const topContainer = document.getElementById('top-performer');
          topContainer.innerHTML = '';
          if (topPerformers.length === 0) {
              topContainer.innerHTML = '<p class="text-gray-500">Data tidak cukup.</p>';
          } else {
              topPerformers.forEach((emp, index) => {
                  const div = document.createElement('div');
                  div.className = 'flex justify-between items-center p-3 bg-green-50 rounded-lg';
                  div.innerHTML = `
                      <div class="flex items-center">
                          <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">${index + 1}</span>
                          <span class="font-medium">${emp.nama}</span>
                      </div>
                      <div class="text-xs text-right space-y-1">
                         <span class="block text-green-600 font-bold">${emp.hadir} Hadir</span>
                         <span class="block text-yellow-600 font-bold">${emp.telat} Telat</span>
                         <span class="block text-red-600 font-bold">${emp.tidakAbsen} T.Hadir</span>
                         <span class="block text-purple-600 font-bold">${emp.izin} Izin</span>
                         <span class="block text-red-500 font-bold">${emp.sakit} Sakit</span>
                      </div>
                  `;
                  topContainer.appendChild(div);
              });
          }

          // Yang perlu perhatian (skor terendah atau masalah terbanyak)
          const needAttention = Object.keys(stats.employeeStats)
              .map(nama => {
                  const empStats = stats.employeeStats[nama];
                  return {
                      nama,
                      masalah: empStats.tidakAbsen + empStats.telat,
                      hadir: empStats.hadir,
                      tidakAbsen: empStats.tidakAbsen,
                      telat: empStats.telat,
                      sakit: empStats.sakit,
                      izin: empStats.izin,
                      score: empStats.score
                  };
              })
              .sort((a, b) => b.masalah - a.masalah || a.score - b.score) // Prioritaskan masalah terbanyak, lalu skor terendah
              .slice(0, 5);

          const attentionContainer = document.getElementById('need-attention');
          attentionContainer.innerHTML = '';
          if (needAttention.length === 0) {
              attentionContainer.innerHTML = '<p class="text-gray-500">Tidak ada data.</p>';
          } else {
              needAttention.forEach((emp, index) => {
                  const div = document.createElement('div');
                  div.className = 'flex justify-between items-center p-3 bg-red-50 rounded-lg';
                  div.innerHTML = `
                      <div class="flex items-center">
                          <span class="w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">${index + 1}</span>
                          <span class="font-medium">${emp.nama}</span>
                      </div>
                      <div class="text-xs text-right space-y-1">
                         <span class="block text-red-600 font-bold">${emp.tidakAbsen} T.Hadir</span>
                         <span class="block text-yellow-600 font-bold">${emp.telat} Telat</span>
                         <span class="block text-green-600 font-bold">${emp.hadir} Hadir</span>
                         <span class="block text-purple-600 font-bold">${emp.izin} Izin</span>
                         <span class="block text-red-500 font-bold">${emp.sakit} Sakit</span>
                      </div>
                  `;
                  attentionContainer.appendChild(div);
              });
          }
      }

      // Buat heatmap
      function createHeatmap(employees) {
          const container = document.getElementById('heatmap-container');
          container.innerHTML = '';
          
          const table = document.createElement('table');
          table.className = 'min-w-full border-collapse';

          // Header tanggal (Baris 1)
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          // Buat header Karyawan sticky dan span 2 baris
          headerRow.innerHTML = '<th class="sticky left-0 bg-white p-2 text-left font-semibold text-gray-700 min-w-32 z-20" rowspan="2">Karyawan</th>';
          for (let day = 1; day <= 31; day++) {
              const th = document.createElement('th');
              th.className = 'p-1 text-xs text-gray-600 font-medium text-center';
              th.colSpan = 2; // Setiap tanggal mencakup 2 kolom (D dan P)
              th.textContent = day;
              headerRow.appendChild(th);
          }
          thead.appendChild(headerRow);
          
          // Sub-header D/P (Baris 2)
          const subHeaderRow = document.createElement('tr');
          for (let day = 1; day <= 31; day++) {
              const thD = document.createElement('th');
              thD.className = 'p-1 text-xs text-gray-500 font-medium bg-gray-50';
              thD.textContent = 'D';
              subHeaderRow.appendChild(thD);
              
              const thP = document.createElement('th');
              thP.className = 'p-1 text-xs text-gray-500 font-medium bg-gray-50';
              thP.textContent = 'P';
              subHeaderRow.appendChild(thP);
          }
          thead.appendChild(subHeaderRow);
          table.appendChild(thead);

          // Baris karyawan (tbody)
          const tbody = document.createElement('tbody');
          employees.forEach(emp => {
              const row = document.createElement('tr');
              row.className = 'border-t border-gray-200';
              
              const nameCell = document.createElement('td');
              nameCell.className = 'sticky left-0 bg-white p-2 font-medium text-gray-800 text-sm whitespace-nowrap z-10';
              nameCell.textContent = emp.nama;
              row.appendChild(nameCell);

              // Loop 31 hari, buat 2 sel per hari (Datang dan Pulang)
              for (let day = 0; day < 31; day++) {
                  
                  // --- Sel 1: DATANG (Masuk) ---
                  const cellMasuk = document.createElement('td');
                  cellMasuk.className = 'p-1 text-center';
                  
                  const statusDivMasuk = document.createElement('div');
                  statusDivMasuk.className = 'heatmap-cell mx-auto cursor-pointer';
                  
                  const status = emp.absenMasuk[day] || '';
                  let statusText = '';
                  let statusClass = '';
                  
                  switch (status) {
                      case 'v':  statusClass = 'status-hadir'; statusText = 'Hadir'; break;
                      case 'x':  statusClass = 'status-hadir-salah-lokasi'; statusText = 'Hadir (Salah Lokasi)'; break;
                      case 't':  statusClass = 'status-telat'; statusText = 'Telat'; break;
                      case 'tx': statusClass = 'status-telat-salah-lokasi'; statusText = 'Telat (Salah Lokasi)'; break;
                      case 's':  statusClass = 'status-sakit'; statusText = 'Sakit'; break;
                      case 'sx': statusClass = 'status-sakit-salah-lokasi'; statusText = 'Sakit (Salah Lokasi)'; break;
                      case 'i':  statusClass = 'status-izin'; statusText = 'Izin'; break;
                      case 'ix': statusClass = 'status-izin-salah-lokasi'; statusText = 'Izin (Salah Lokasi)'; break;
                      case 'a':  // 'a' eksplisit
                      case '':   // String kosong (implisit 'a')
                          statusClass = 'status-tidak-absen'; 
                          statusText = 'Tidak Absen'; 
                          break;
                      case 'h':  statusClass = 'bg-gray-200'; statusText = 'Hari Libur'; break;
                      default:   statusClass = 'bg-gray-100'; statusText = 'Tidak Ada Data';
                  }
                  
                  statusDivMasuk.classList.add(statusClass);
                  statusDivMasuk.title = `${emp.nama} - Hari ${day + 1} (Datang): ${statusText}`;
                  cellMasuk.appendChild(statusDivMasuk);
                  row.appendChild(cellMasuk);

                  // --- Sel 2: PULANG ---
                  const cellPulang = document.createElement('td');
                  cellPulang.className = 'p-1 text-center';
                  
                  const statusDivPulang = document.createElement('div');
                  statusDivPulang.className = 'heatmap-cell mx-auto cursor-pointer';

                  const statusP = emp.absenPulang[day] || '';
                  let statusTextP = '';
                  let statusClassP = '';

                  // Asumsi 'v' adalah kode untuk pulang, kode lain dianggap 'Tidak Ada Data'
                  if (statusP === 'v') {
                      statusClassP = 'status-pulang';
                      statusTextP = 'Pulang';
                  } else {
                      statusClassP = 'bg-gray-100';
                      statusTextP = 'Tidak Ada Data';
                  }

                  statusDivPulang.classList.add(statusClassP);
                  statusDivPulang.title = `${emp.nama} - Hari ${day + 1} (Pulang): ${statusTextP}`;
                  cellPulang.appendChild(statusDivPulang);
                  row.appendChild(cellPulang);
              }
              
              tbody.appendChild(row);
          });
          table.appendChild(tbody);
          container.appendChild(table);
      }

      // [BARU] Mengisi dropdown filter karyawan
      function populateEmployeeFilter(employees) {
          const select = document.getElementById('employee-filter');
          if (!select) return;

          // Hapus opsi lama (kecuali yang pertama)
          select.innerHTML = '<option value="all">Semua Karyawan</option>';
          
          employees.forEach(emp => {
              const option = document.createElement('option');
              option.value = emp.nama;
              option.textContent = emp.nama;
              select.appendChild(option);
          });

          // Tambahkan event listener
          select.addEventListener('change', filterDashboard);
      }

      // [BARU] Fungsi utama untuk memfilter dan me-render ulang dashboard
      function filterDashboard() {
          const selectedValue = document.getElementById('employee-filter').value;
          
          let filteredEmployees;
          if (selectedValue === 'all') {
              filteredEmployees = currentData; // Gunakan semua data
          } else {
              filteredEmployees = currentData.filter(emp => emp.nama === selectedValue); // Filter satu karyawan
          }

          // 1. Analisis data yang sudah difilter
          const stats = analyzeData(filteredEmployees);
          
          // 2. Render ulang semua modul dengan data yang sudah difilter
          createLateTrendChart(stats);
          createLocationChart(stats);
          createAbsentTrendChart(stats); // [BARU]
          createTopLists(stats);
          createHeatmap(filteredEmployees); // Heatmap perlu data mentah karyawan
      }

      // Load dan render dashboard
      async function loadDashboard() {
          const config = window.elementSdk?.config || defaultConfig;
          const sheetId = config.sheet_id || defaultConfig.sheet_id;
          const sheetName = config.sheet_name || defaultConfig.sheet_name;
          const companyName = config.company_name || defaultConfig.company_name;

          document.getElementById('dashboard-title').textContent = companyName;
          document.getElementById('company-subtitle').textContent = `Data Real-time dari Google Sheet`;

          try {
              document.getElementById('loading-state').style.display = 'block';
              document.getElementById('error-state').style.display = 'none';
              document.getElementById('dashboard-content').style.display = 'none';

              // 1. Ambil data penuh
              const employees = await fetchSheetData(sheetId, sheetName);
              currentData = employees; // Simpan data penuh secara global
              
              // 2. Isi dropdown filter
              populateEmployeeFilter(employees);
              
              // 3. Render dashboard awal (dengan "Semua Karyawan")
              filterDashboard();
              
              document.getElementById('loading-state').style.display = 'none';
              document.getElementById('dashboard-content').style.display = 'block';
              
          } catch (error)
 {
              console.error("Dashboard Gagal Dimuat:", error);
              document.getElementById('loading-state').style.display = 'none';
              document.getElementById('error-state').style.display = 'block';
              document.getElementById('error-message').textContent = error.message;
          }
      }
      
      // --- Inisialisasi Element SDK (Jika ada) ---
      // Kode ini menangani jika dijalankan di dalam platform
      async function onConfigChange(config) {
          // Muat ulang dashboard jika konfigurasi berubah
          await loadDashboard();
      }

      function mapToCapabilities(config) {
          return {
              recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined
          };
      }

      function mapToEditPanelValues(config) {
          return new Map([
              ['sheet_id', config.sheet_id || defaultConfig.sheet_id],
              ['sheet_name', config.sheet_name || defaultConfig.sheet_name],
              ['company_name', config.company_name || defaultConfig.company_name]
          ]);
      }
      
      // Initialize
      document.addEventListener('DOMContentLoaded', async () => {
          if (window.elementSdk) {
              // Inisialisasi jika SDK ditemukan
              await window.elementSdk.init({
                  defaultConfig,
                  onConfigChange,
                  mapToCapabilities,
                  mapToEditPanelValues
              });
          }
          
          // Muat dashboard saat halaman siap
          await loadDashboard();
      });
  </script>
</body>
</html>


