<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Absensi Google Sheet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      body {
          font-family: 'Inter', sans-serif;
          box-sizing: border-box;
      }
      .metric-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .metric-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      }
      .heatmap-cell {
          width: 25px;
          height: 25px;
          border-radius: 4px;
          transition: all 0.2s ease;
          position: relative;
      }
      .heatmap-cell:hover {
          transform: scale(1.2);
          z-index: 10;
      }
      
      /* Definisi Status
        v = Hadir Tepat (Hadir, Lokasi Benar)
        x = Hadir Salah Lokasi (Hadir, Lokasi Salah)
        t = Telat Tepat (Telat, Lokasi Benar)
        tx = Telat Salah Lokasi (Telat, Lokasi Salah)
        s = Sakit (dengan lampiran, dianggap lokasi benar)
        sx = Sakit (tanpa lampiran, dianggap lokasi salah)
        i = Izin (dengan lampiran, dianggap lokasi benar)
        ix = Izin (tanpa lampiran, dianggap lokasi salah)
        a = Tidak Absen (Alpa)
      */

      /* Hadir */
      .status-hadir { background-color: #10b981; } /* v */
      .status-hadir-salah-lokasi { background-color: #84cc16; } /* x */
      
      /* Telat */
      .status-telat { background-color: #f59e0b; } /* t */
      .status-telat-salah-lokasi { background-color: #fb923c; } /* tx */

      /* Sakit */
      .status-sakit { background-color: #ef4444; } /* s */
      .status-sakit-salah-lokasi { background-color: #f87171; } /* sx */

      /* Izin */
      .status-izin { background-color: #8b5cf6; } /* i */
      .status-izin-salah-lokasi { background-color: #a78bfa; } /* ix */

      /* Tidak Absen */
      .status-tidak-absen { background-color: #6b7280; } /* a */
      
      .loading {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #3498db;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      /* Style untuk font Inter */
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 sm:px-6 py-8">
    
    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-2" id="dashboard-title">Dashboard Absensi Karyawan</h1>
      <p class="text-gray-600" id="company-subtitle">Data Real-time dari Google Sheet</p>
    </header>
    
    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
      <div class="loading mx-auto mb-4"></div>
      <p class="text-gray-600">Memuat data dari Google Sheet...</p>
    </div>
    
    <!-- Error State -->
    <div id="error-state" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 mb-8">
      <div class="flex items-center">
        <div class="text-red-500 text-3xl mr-4">‚ö†Ô∏è</div>
        <div>
          <h3 class="text-red-800 font-semibold text-lg">Gagal Memuat Data</h3>
          <p class="text-red-600" id="error-message">Tidak dapat mengakses Google Sheet. Pastikan sheet dapat diakses publik.</p>
        </div>
      </div>
    </div>
    
    <!-- Main Dashboard Content -->
    <div id="dashboard-content" class="hidden">
      
      <!-- Papan Skor Utama -->
      <section class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">üìä Papan Skor Utama (Bulan Ini)</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          
          <div class="metric-card text-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-100 text-sm font-medium uppercase tracking-wider">Tingkat Kehadiran</p>
                <p class="text-4xl font-bold" id="tingkat-kehadiran">-</p>
              </div>
              <div class="text-5xl opacity-70">üéØ</div>
            </div>
          </div>
          
          <div class="metric-card text-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-100 text-sm font-medium uppercase tracking-wider">Total Keterlambatan</p>
                <p class="text-4xl font-bold" id="total-telat">-</p>
              </div>
              <div class="text-5xl opacity-70">‚è∞</div>
            </div>
          </div>
          
          <div class="metric-card text-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-100 text-sm font-medium uppercase tracking-wider">Total Tidak Hadir</p>
                <p class="text-4xl font-bold" id="total-tidak-hadir">-</p>
              </div>
              <div class="text-5xl opacity-70">üìã</div>
            </div>
          </div>
          
          <div class="metric-card text-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-100 text-sm font-medium uppercase tracking-wider">Karyawan Terbaik</p>
                <p class="text-xl font-bold" id="karyawan-terbaik">-</p>
              </div>
              <div class="text-5xl opacity-70">‚≠ê</div>
            </div>
          </div>
          
        </div>
      </section>
      
      <!-- Grafik Tren -->
      <section class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">üìà Analisis Kehadiran</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          
          <!-- Grafik Status Kehadiran -->
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Distribusi Status Kehadiran</h3>
            <canvas id="chartStatus" width="400" height="200"></canvas>
          </div>
          
          <!-- Grafik Akurasi Lokasi -->
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Akurasi Lokasi Absen</h3>
            <canvas id="chartLokasi" width="400" height="200"></canvas>
          </div>
          
        </div>
      </section>
      
      <!-- Daftar Karyawan -->
      <section class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">üë• Performa Karyawan</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          
          <!-- Top Performer -->
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><span class="text-green-500 mr-2 text-2xl">‚≠ê</span> Top 5 Karyawan Terbaik</h3>
            <div class="space-y-3" id="top-performer">
              <!-- Data akan diisi oleh JavaScript -->
            </div>
          </div>
          
          <!-- Perlu Perhatian -->
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><span class="text-red-500 mr-2 text-2xl">‚ö†Ô∏è</span> 5 Karyawan Perlu Perhatian</h3>
            <div class="space-y-3" id="need-attention">
              <!-- Data akan diisi oleh JavaScript -->
            </div>
          </div>
          
        </div>
      </section>
      
      <!-- Peta Panas Kehadiran -->
      <section class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">üî• Peta Panas Kehadiran</h2>
        <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
          
          <!-- Legenda Heatmap -->
          <div class="mb-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 text-sm">
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-hadir"></div><span>Hadir</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-hadir-salah-lokasi"></div><span>Hadir (Salah Lokasi)</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-telat"></div><span>Telat</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-telat-salah-lokasi"></div><span>Telat (Salah Lokasi)</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-sakit"></div><span>Sakit</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-izin"></div><span>Izin</span></div>
            <div class="flex items-center"><div class="w-4 h-4 rounded mr-2 status-tidak-absen"></div><span>Tidak Absen</span></div>
          </div>
          
          <div id="heatmap-container">
            <!-- Heatmap akan diisi oleh JavaScript -->
          </div>
          
        </div>
      </section>
      
    </div>
  </div>
  
  <script>
      // --- KONFIGURASI ---
      const defaultConfig = {
          // ID Google Sheet Anda sudah terpasang di sini
          sheet_id: '1wCVC1jC6cSp5jIRUxTlDLOM-CyUNnSuTe8tegh3Y8QA',
          // Nama sheet (tab) yang berisi data
          sheet_name: 'Laporan',
          // Judul Dashboard
          company_name: 'Dashboard Absensi Karyawan'
      };

      let currentData = null;
      let charts = {};

      // Fungsi untuk mengambil data dari Google Sheet
      async function fetchSheetData(sheetId, sheetName) {
          try {
              // Menggunakan endpoint gviz/tq untuk mendapatkan JSON
              const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
              const response = await fetch(url);
              
              if (!response.ok) {
                  throw new Error(`Google Sheet merespon dengan status: ${response.status}`);
              }
              
              const text = await response.text();
              
              // Membersihkan response JSONP dari Google
              const jsonText = text.substring(47).slice(0, -2);
              const data = JSON.parse(jsonText);
              
              if (data.status === 'error') {
                  throw new Error(`Error dari Google Sheet API: ${data.errors.map(e => e.detailed_message).join(', ')}`);
              }

              return parseSheetData(data);
          } catch (error) {
              console.error('Error fetching sheet data:', error);
                  throw new Error(`Gagal mengambil data. Pastikan Google Sheet Anda sudah di "Publish to the web" dan nama sheet ("${sheetName}") sudah benar.`);
          }
      }

      // Parse data dari Google Sheet
      function parseSheetData(data) {
          const rows = data.table.rows;
          const employees = [];
          
          if (!rows || rows.length < 2) {
              throw new Error("Data tidak ditemukan atau format sheet salah. Pastikan baris pertama adalah header.");
          }

          // Skip header row (i = 0), mulai dari data (i = 1)
          // Berdasarkan gambar Anda, data karyawan mulai dari baris 5 (index 4)
          for (let i = 4; i < rows.length; i++) {
              const row = rows[i];
              // Pastikan baris dan kolom nama ada (Kolom A, index 0)
              if (!row.c || !row.c[0] || typeof row.c[0].v !== 'string' || row.c[0].v.trim() === '') {
                  continue; // Lewati baris jika tidak ada nama
              }
              
              const employee = {
                  nama: row.c[0].v.trim(),
                  absenMasuk: [],
                  absenPulang: []
              };
              
              // Parse absen masuk (Kolom D-AH, index 3-33)
              // 31 hari
              for (let j = 3; j <= 33; j++) {
                  let status = (row.c[j] && row.c[j].v) ? String(row.c[j].v).toLowerCase().trim() : '';
                  employee.absenMasuk.push(status);
              }
              
              // Parse absen pulang (Kolom AI-BM, index 34-64)
              // 31 hari
              for (let j = 34; j <= 64; j++) {
                  let status = (row.c[j] && row.c[j].v) ? String(row.c[j].v).toLowerCase().trim() : '';
                  employee.absenPulang.push(status);
              }
              
              employees.push(employee);
          }
          
          if (employees.length === 0) {
              throw new Error("Tidak ada data karyawan yang valid ditemukan di sheet.");
          }
          
          return employees;
      }

      // Analisis data absensi
      function analyzeData(employees) {
          const stats = {
              totalHadir: 0,
              totalTelat: 0,
              totalSakit: 0,
              totalIzin: 0,
              totalTidakAbsen: 0,
              totalLokasiBenar: 0,
              totalLokasiSalah: 0,
              employeeStats: {}
          };

          employees.forEach(emp => {
              stats.employeeStats[emp.nama] = {
                  hadir: 0, telat: 0, sakit: 0, izin: 0, tidakAbsen: 0,
                  lokasiBenar: 0, lokasiSalah: 0, score: 0
              };

              // Kita hanya menganalisis 'absenMasuk' (kolom B-AF) untuk statistik utama
              emp.absenMasuk.forEach(status => {
                  if (!status || status === 'h') return; // 'h' adalah hari libur, diabaikan
                  
                  const empStat = stats.employeeStats[emp.nama];
                  
                  switch (status) {
                      case 'v': // Hadir Tepat
                          stats.totalHadir++;
                          empStat.hadir++;
                          stats.totalLokasiBenar++;
                          empStat.lokasiBenar++;
                          empStat.score += 10;
                          break;
                      case 'x': // Hadir Salah Lokasi
                          stats.totalHadir++;
                          empStat.hadir++;
                          stats.totalLokasiSalah++;
                          empStat.lokasiSalah++;
                          empStat.score += 7; // Skor lebih rendah
                          break;
                      case 't': // Telat Tepat
                          stats.totalTelat++;
                          empStat.telat++;
                          stats.totalLokasiBenar++;
                          empStat.lokasiBenar++;
                          empStat.score += 5; // Skor lebih rendah
                          break;
                      case 'tx': // Telat Salah Lokasi
                          stats.totalTelat++;
                          empStat.telat++;
                          stats.totalLokasiSalah++;
                          empStat.lokasiSalah++;
                          empStat.score += 3; // Skor sangat rendah
                          break;
                      case 's': // Sakit (dianggap lokasi benar)
                          stats.totalSakit++;
                          empStat.sakit++;
                          stats.totalLokasiBenar++;
                          empStat.lokasiBenar++;
                          empStat.score += 2; // Skor netral
                          break;
                      case 'sx': // Sakit (salah lokasi/tanpa surat)
                          stats.totalSakit++;
                          empStat.sakit++;
                          stats.totalLokasiSalah++;
                          empStat.lokasiSalah++;
                          empStat.score += 1; // Skor rendah
                          break;
                      case 'i': // Izin (dianggap lokasi benar)
                          stats.totalIzin++;
                          empStat.izin++;
                          stats.totalLokasiBenar++;
                          empStat.lokasiBenar++;
                          empStat.score += 2; // Skor netral
                          break;
                      case 'ix': // Izin (salah lokasi/tanpa surat)
                          stats.totalIzin++;
                          empStat.izin++;
                          stats.totalLokasiSalah++;
                          empStat.lokasiSalah++;
                          empStat.score += 1; // Skor rendah
                          break;
                      case 'a': // Alpa / Tidak Absen
                          stats.totalTidakAbsen++;
                          empStat.tidakAbsen++;
                          empStat.score -= 5; // Skor minus
                          break;
                  }
              });
          });

          return stats;
      }

      // Update papan skor
      function updateScoreboard(stats) {
          const totalKehadiran = stats.totalHadir + stats.totalTelat;
          const totalAbsensiValid = totalKehadiran + stats.totalSakit + stats.totalIzin + stats.totalTidakAbsen;
          
          // Tingkat kehadiran = (Hadir + Telat) / Total Hari Kerja (Hadir + Telat + Sakit + Izin + Alpa)
          const tingkatKehadiran = totalAbsensiValid > 0 
              ? Math.round((totalKehadiran / totalAbsensiValid) * 100) 
              : 0;

          document.getElementById('tingkat-kehadiran').textContent = tingkatKehadiran + '%';
          document.getElementById('total-telat').textContent = stats.totalTelat;
          
          // Total Tidak Hadir = Sakit + Izin + Alpa
          document.getElementById('total-tidak-hadir').textContent = stats.totalSakit + stats.totalIzin + stats.totalTidakAbsen;

          // Cari karyawan terbaik
          let bestEmployee = '';
          let bestScore = -Infinity;
          Object.keys(stats.employeeStats).forEach(nama => {
              if (stats.employeeStats[nama].score > bestScore) {
                  bestScore = stats.employeeStats[nama].score;
                  bestEmployee = nama;
              }
          });
          document.getElementById('karyawan-terbaik').textContent = bestEmployee || '-';
      }

      // Buat grafik status
      function createStatusChart(stats) {
          if (charts.status) charts.status.destroy();
          
          const ctx = document.getElementById('chartStatus').getContext('2d');
          charts.status = new Chart(ctx, {
              type: 'doughnut',
              data: {
                  labels: ['Hadir Tepat Waktu', 'Telat', 'Sakit', 'Izin', 'Tidak Absen'],
                  datasets: [{
                      data: [
                          stats.totalHadir,
                          stats.totalTelat,
                          stats.totalSakit,
                          stats.totalIzin,
                          stats.totalTidakAbsen
                      ],
                      backgroundColor: [
                          '#10b981', // Hadir
                          '#f59e0b', // Telat
                          '#ef4444', // Sakit
                          '#8b5cf6', // Izin
                          '#6b7280'  // Tidak Absen
                      ]
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      legend: {
                          position: 'bottom'
                      }
                  }
              }
          });
      }

      // Buat grafik lokasi
      function createLocationChart(stats) {
          if (charts.location) charts.location.destroy();
          
          const ctx = document.getElementById('chartLokasi').getContext('2d');
          charts.location = new Chart(ctx, {
              type: 'pie',
              data: {
                  labels: ['Lokasi Benar', 'Lokasi Salah'],
                  datasets: [{
                      data: [stats.totalLokasiBenar, stats.totalLokasiSalah],
                      backgroundColor: ['#10b981', '#ef4444']
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      legend: {
                          position: 'bottom'
                      }
                  }
              }
          });
      }

      // Buat daftar top performer
      function createTopLists(stats) {
          // Top 5 performer
          const topPerformers = Object.keys(stats.employeeStats)
              .map(nama => ({
                  nama,
                  score: stats.employeeStats[nama].score
              }))
              .sort((a, b) => b.score - a.score) // Urutkan dari skor tertinggi
              .slice(0, 5);

          const topContainer = document.getElementById('top-performer');
          topContainer.innerHTML = '';
          if (topPerformers.length === 0) {
              topContainer.innerHTML = '<p class="text-gray-500">Data tidak cukup.</p>';
          } else {
              topPerformers.forEach((emp, index) => {
                  const div = document.createElement('div');
                  div.className = 'flex justify-between items-center p-3 bg-green-50 rounded-lg';
                  div.innerHTML = `
                      <div class="flex items-center">
                          <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">${index + 1}</span>
                          <span class="font-medium">${emp.nama}</span>
                      </div>
                      <span class="text-green-600 font-bold">${emp.score} poin</span>
                  `;
                  topContainer.appendChild(div);
              });
          }

          // Yang perlu perhatian (skor terendah atau masalah terbanyak)
          const needAttention = Object.keys(stats.employeeStats)
              .map(nama => ({
                  nama,
                  masalah: stats.employeeStats[nama].tidakAbsen + stats.employeeStats[nama].telat,
                  score: stats.employeeStats[nama].score
              }))
              .sort((a, b) => b.masalah - a.masalah || a.score - b.score) // Prioritaskan masalah terbanyak, lalu skor terendah
              .slice(0, 5);

          const attentionContainer = document.getElementById('need-attention');
          attentionContainer.innerHTML = '';
          if (needAttention.length === 0) {
              attentionContainer.innerHTML = '<p class="text-gray-500">Tidak ada data.</p>';
          } else {
              needAttention.forEach((emp, index) => {
                  const div = document.createElement('div');
                  div.className = 'flex justify-between items-center p-3 bg-red-50 rounded-lg';
                  div.innerHTML = `
                      <div class="flex items-center">
                          <span class="w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">${index + 1}</span>
                          <span class="font-medium">${emp.nama}</span>
                      </div>
                      <span class="text-red-600 font-bold">${emp.masalah} masalah</span>
                  `;
                  attentionContainer.appendChild(div);
              });
          }
      }

      // Buat heatmap
      function createHeatmap(employees) {
          const container = document.getElementById('heatmap-container');
          container.innerHTML = '';
          
          const table = document.createElement('table');
          table.className = 'min-w-full border-collapse';

          // Header tanggal
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          headerRow.innerHTML = '<th class="sticky left-0 bg-white p-2 text-left font-semibold text-gray-700 min-w-32 z-10">Karyawan</th>';
          for (let day = 1; day <= 31; day++) {
              const th = document.createElement('th');
              th.className = 'p-1 text-xs text-gray-600 font-medium';
              th.textContent = day;
              headerRow.appendChild(th);
          }
          thead.appendChild(headerRow);
          table.appendChild(thead);

          // Baris karyawan
          const tbody = document.createElement('tbody');
          employees.forEach(emp => {
              const row = document.createElement('tr');
              row.className = 'border-t border-gray-200';
              
              const nameCell = document.createElement('td');
              nameCell.className = 'sticky left-0 bg-white p-2 font-medium text-gray-800 text-sm whitespace-nowrap z-10';
              nameCell.textContent = emp.nama;
              row.appendChild(nameCell);

              for (let day = 0; day < 31; day++) {
                  const cell = document.createElement('td');
                  cell.className = 'p-1 text-center';
                  
                  const statusDiv = document.createElement('div');
                  statusDiv.className = 'heatmap-cell mx-auto cursor-pointer';
                  
                  const status = emp.absenMasuk[day] || '';
                  let statusText = '';
                  let statusClass = '';
                  
                  switch (status) {
                      case 'v':  statusClass = 'status-hadir'; statusText = 'Hadir'; break;
                      case 'x':  statusClass = 'status-hadir-salah-lokasi'; statusText = 'Hadir (Salah Lokasi)'; break;
                      case 't':  statusClass = 'status-telat'; statusText = 'Telat'; break;
                      case 'tx': statusClass = 'status-telat-salah-lokasi'; statusText = 'Telat (Salah Lokasi)'; break;
                      case 's':  statusClass = 'status-sakit'; statusText = 'Sakit'; break;
                      case 'sx': statusClass = 'status-sakit-salah-lokasi'; statusText = 'Sakit (Salah Lokasi)'; break;
                      case 'i':  statusClass = 'status-izin'; statusText = 'Izin'; break;
                      case 'ix': statusClass = 'status-izin-salah-lokasi'; statusText = 'Izin (Salah Lokasi)'; break;
                      case 'a':  statusClass = 'status-tidak-absen'; statusText = 'Tidak Absen'; break;
                      case 'h':  statusClass = 'bg-gray-200'; statusText = 'Hari Libur'; break;
                      default:   statusClass = 'bg-gray-100'; statusText = 'Tidak Ada Data';
                  }
                  
                  statusDiv.classList.add(statusClass);
                  statusDiv.title = `${emp.nama} - Hari ${day + 1}: ${statusText}`;
                  cell.appendChild(statusDiv);
                  row.appendChild(cell);
              }
              
              tbody.appendChild(row);
          });
          table.appendChild(tbody);
          container.appendChild(table);
      }

      // Load dan render dashboard
      async function loadDashboard() {
          const config = window.elementSdk?.config || defaultConfig;
          const sheetId = config.sheet_id || defaultConfig.sheet_id;
          const sheetName = config.sheet_name || defaultConfig.sheet_name;
          const companyName = config.company_name || defaultConfig.company_name;

          document.getElementById('dashboard-title').textContent = companyName;
          document.getElementById('company-subtitle').textContent = `Data Real-time dari Google Sheet`;

          try {
              document.getElementById('loading-state').style.display = 'block';
              document.getElementById('error-state').style.display = 'none';
              document.getElementById('dashboard-content').style.display = 'none';

              const employees = await fetchSheetData(sheetId, sheetName);
              currentData = employees;
              
              const stats = analyzeData(employees);
              
              updateScoreboard(stats);
              createStatusChart(stats);
              createLocationChart(stats);
              createTopLists(stats);
              createHeatmap(employees);
              
              document.getElementById('loading-state').style.display = 'none';
              document.getElementById('dashboard-content').style.display = 'block';
              
          } catch (error)
 {
              console.error("Dashboard Gagal Dimuat:", error);
              document.getElementById('loading-state').style.display = 'none';
              document.getElementById('error-state').style.display = 'block';
              document.getElementById('error-message').textContent = error.message;
          }
      }
      
      // --- Inisialisasi Element SDK (Jika ada) ---
      // Kode ini menangani jika dijalankan di dalam platform
      async function onConfigChange(config) {
          // Muat ulang dashboard jika konfigurasi berubah
          await loadDashboard();
      }

      function mapToCapabilities(config) {
          return {
              recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined
          };
      }

      function mapToEditPanelValues(config) {
          return new Map([
              ['sheet_id', config.sheet_id || defaultConfig.sheet_id],
              ['sheet_name', config.sheet_name || defaultConfig.sheet_name],
              ['company_name', config.company_name || defaultConfig.company_name]
          ]);
      }
      
      // Initialize
      document.addEventListener('DOMContentLoaded', async () => {
          if (window.elementSdk) {
              // Inisialisasi jika SDK ditemukan
              await window.elementSdk.init({
                  defaultConfig,
                  onConfigChange,
                  mapToCapabilities,
                  mapToEditPanelValues
              });
          }
          
          // Muat dashboard saat halaman siap
          await loadDashboard();
      });
  </script>
</body>
</html>

