<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Absensi - History & Drill Down</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      body { font-family: 'Inter', sans-serif; }
      
      /* Animasi dan Styling Heatmap */
      .heatmap-cell {
          width: 26px; height: 26px;
          border-radius: 6px;
          transition: all 0.2s ease;
          position: relative;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 10px;
          font-weight: bold;
          color: rgba(255,255,255,0.9);
      }
      .heatmap-cell:hover {
          transform: scale(1.25);
          z-index: 10;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      
      /* Warna Status */
      .status-hadir { background-color: #10b981; } /* v */
      .status-hadir-salah-lokasi { background-color: #84cc16; } /* x */
      .status-telat { background-color: #f59e0b; } /* t */
      .status-telat-salah-lokasi { background-color: #fb923c; } /* tx */
      .status-sakit { background-color: #ef4444; } /* s */
      .status-sakit-salah-lokasi { background-color: #f87171; } /* sx */
      .status-izin { background-color: #8b5cf6; } /* i */
      .status-izin-salah-lokasi { background-color: #a78bfa; } /* ix */
      .status-tidak-absen { background-color: #6b7280; color: transparent; } /* a */
      .status-pulang { background-color: #3b82f6; } /* Pulang */
      .status-lupa { background-color: #93c5fd; } /* Lupa Absen */
      .status-libur { background-color: #e5e7eb; color: #9ca3af; } /* h */
      .status-nodata { background-color: #f3f4f6; color: transparent; } 

      .loading {
          width: 24px; height: 24px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #3b82f6;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <div class="container mx-auto px-4 py-6">
    
    <!-- Header Control Panel -->
    <header class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <div>
          <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
            üìä Dashboard Presensi
            <span id="current-period-badge" class="bg-blue-100 text-blue-800 text-xs px-2.5 py-0.5 rounded-full hidden">...</span>
          </h1>
          <p class="text-gray-500 text-sm mt-1">Monitoring kehadiran, lokasi, dan jam kerja karyawan.</p>
        </div>

        <!-- Filter Controls -->
        <div class="flex flex-wrap gap-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
          <div class="flex gap-2">
             <select id="filter-month" onchange="renderDashboard()" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-md p-2"><option value="">Bulan...</option></select>
             <select id="filter-year" onchange="renderDashboard()" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-md p-2"><option value="">Tahun...</option></select>
          </div>
          <div class="w-px bg-gray-300 mx-1"></div>
          <select id="filter-employee" onchange="renderDashboard()" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-md p-2 min-w-[150px]">
            <option value="all">Semua Tim</option>
          </select>
          <button onclick="initApp()" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
          </button>
        </div>
      </div>
    </header>

    <!-- State Loading & Error -->
    <div id="loading-state" class="text-center py-20 hidden">
      <div class="loading mx-auto mb-4"></div>
      <p class="text-gray-600 font-medium animate-pulse">Sinkronisasi Sheet...</p>
    </div>
    <div id="error-state" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 mb-8 text-center">
      <h3 class="text-red-800 font-bold text-lg mb-2">Koneksi Gagal</h3>
      <p class="text-red-600 text-sm" id="error-message"></p>
      <button onclick="initApp()" class="mt-4 text-sm text-red-700 underline">Coba Lagi</button>
    </div>

    <!-- Konten Dashboard -->
    <div id="dashboard-content" class="hidden space-y-6">
      <!-- Stats Cards -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><p class="text-xs text-gray-500 uppercase font-bold">Hadir</p><p class="text-3xl font-bold text-gray-800 mt-1" id="stat-hadir">0</p></div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><p class="text-xs text-gray-500 uppercase font-bold">Terlambat</p><p class="text-3xl font-bold text-yellow-600 mt-1" id="stat-telat">0</p></div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><p class="text-xs text-gray-500 uppercase font-bold">Sakit/Izin</p><p class="text-3xl font-bold text-red-600 mt-1" id="stat-izin">0</p></div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><p class="text-xs text-gray-500 uppercase font-bold">Alpa</p><p class="text-3xl font-bold text-purple-600 mt-1" id="stat-alpa">0</p></div>
      </div>

      <!-- Heatmap -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
        <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4">
          <h2 class="text-lg font-bold text-gray-800">üî• Grid Absensi Bulanan</h2>
          <div class="flex flex-wrap justify-center gap-3 text-xs text-gray-600">
             <div class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-sm mr-1"></span>Hadir</div>
             <div class="flex items-center"><span class="w-3 h-3 bg-yellow-500 rounded-sm mr-1"></span>Telat</div>
             <div class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-sm mr-1"></span>Pulang</div>
             <div class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-sm mr-1"></span>Sakit/Izin</div>
             <div class="flex items-center"><span class="w-3 h-3 bg-gray-500 rounded-sm mr-1"></span>Alpa</div>
          </div>
        </div>
        <div class="overflow-x-auto p-2"><div id="heatmap-container" class="min-w-[800px]"></div></div>
      </div>
      
      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-2">
            <h3 class="font-bold text-gray-700 mb-4">Tren Keterlambatan Harian</h3>
            <canvas id="chartLate" height="120"></canvas>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 class="font-bold text-gray-700 mb-4">üèÜ Top Rajin (Skor)</h3>
            <div id="top-performer-list" class="space-y-3"></div>
          </div>
      </div>
    </div>
  </div>

  <!-- Modal Drill-Down -->
  <div id="detailModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900 bg-opacity-60 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-md border border-gray-200">
          <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex justify-between items-center">
            <h3 class="text-lg font-bold text-white" id="modal-title">Detail Aktivitas</h3>
            <button onclick="closeModal()" class="text-blue-100 hover:text-white text-2xl leading-none">&times;</button>
          </div>
          <div class="px-6 py-6 space-y-5">
            <div class="flex items-center space-x-4 border-b border-gray-100 pb-4">
               <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 font-bold text-xl border border-blue-100" id="modal-avatar">A</div>
               <div>
                  <h4 class="text-lg font-bold text-gray-900" id="modal-nama">-</h4>
                  <p class="text-sm text-gray-500" id="modal-tanggal">-</p>
               </div>
               <div class="ml-auto flex flex-col items-end">
                   <span id="modal-status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-600 mb-1">-</span>
                   <span class="text-[10px] text-gray-400 font-mono" id="modal-tipe">MASUK</span>
               </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-1">Jam Catat</p>
                    <p class="text-xl font-mono font-bold text-gray-800" id="modal-jam">--:--</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-1">Jarak Kantor</p>
                    <p class="text-sm font-medium text-gray-800 mt-1 truncate" id="modal-jarak">-</p>
                </div>
            </div>
            
            <a id="modal-maps-link" href="#" target="_blank" class="flex items-center justify-center w-full px-4 py-3 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors group">
              <span class="mr-2">üìç</span> Buka Lokasi di Maps
            </a>

            <!-- Area Foto -->
            <div id="modal-foto-container" class="hidden">
               <p class="text-xs text-gray-500 mb-2 font-semibold">üì∑ Bukti Foto</p>
               <div class="relative aspect-[3/4] w-full bg-gray-100 rounded-lg overflow-hidden border border-gray-200 shadow-inner group">
                 <img id="modal-foto" src="" alt="Bukti" class="absolute inset-0 w-full h-full object-cover">
               </div>
            </div>
            <!-- Fallback Foto jika Path -->
            <div id="modal-foto-error" class="hidden bg-yellow-50 p-3 rounded-lg text-xs text-yellow-700 border border-yellow-100">
               ‚ö†Ô∏è Foto tersedia di database tapi formatnya jalur file (path), bukan link publik. Tidak dapat ditampilkan di dashboard.
            </div>

            <div id="modal-no-data" class="hidden text-center py-6">
                <div class="inline-block p-3 rounded-full bg-gray-100 mb-2">üö´</div>
                <p class="text-gray-500 text-sm italic">Data digital tidak ditemukan.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
      const CONFIG = {
          sheetId: '1wCVC1jC6cSp5jIRUxTlDLOM-CyUNnSuTe8tegh3Y8QA', 
          sheetNames: {
              data: 'Data',
              arrayMasuk: 'Array Absen Masuk',
              arrayPulang: 'Array Absen Pulang'
          }
      };

      let rawData = { masterEmp: [], historyMasuk: [], historyPulang: [] };
      let processedData = {};
      let availablePeriods = [];
      let charts = {};

      async function initApp() {
          const loading = document.getElementById('loading-state');
          const errorDiv = document.getElementById('error-state');
          const content = document.getElementById('dashboard-content');
          
          loading.classList.remove('hidden');
          content.classList.add('hidden');
          errorDiv.classList.add('hidden');

          try {
              const [rowsData, rowsMasuk, rowsPulang] = await Promise.all([
                  fetchSheet(CONFIG.sheetNames.data),
                  fetchSheet(CONFIG.sheetNames.arrayMasuk),
                  fetchSheet(CONFIG.sheetNames.arrayPulang)
              ]);

              rawData.masterEmp = parseMasterData(rowsData);
              processedData = {}; 
              parseHistoryArray(rowsMasuk, 'Masuk');
              parseHistoryArray(rowsPulang, 'Pulang');
              populatePeriodFilters();
              
              if(availablePeriods.length > 0) {
                  document.getElementById('filter-year').value = availablePeriods[0].y;
                  document.getElementById('filter-month').value = availablePeriods[0].m;
              }

              renderDashboard();
              loading.classList.add('hidden');
              content.classList.remove('hidden');

          } catch (err) {
              console.error(err);
              loading.classList.add('hidden');
              errorDiv.classList.remove('hidden');
              document.getElementById('error-message').textContent = `Gagal memuat: ${err.message}.`;
          }
      }

      async function fetchSheet(sheetName) {
          // Headers=1 agar kita bisa menghandle header row manual
          const url = `https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}&headers=1`;
          const res = await fetch(url);
          if(!res.ok) throw new Error(`HTTP Error ${res.status}`);
          const text = await res.text();
          const json = JSON.parse(text.substr(47).slice(0, -2));
          return json.table.rows;
      }

      function parseMasterData(rows) {
          // Sheet Data: ID(0), Nama(1), Lokasi(2)
          return rows.map(r => r.c[1]?.v).filter(n => n && n !== 'Nama');
      }

      function parseHistoryArray(rows, type) {
          // Mapping Kolom Array Absen Masuk/Pulang (Updated):
          // Date(2), Time(3), Name(5), Loc(9), Photo(10), Dist(11), Code(14 / ico)
          
          rows.forEach(row => {
              const v = (i) => (row.c[i] && row.c[i].v !== null) ? row.c[i].v : null;
              
              const dateVal = v(2);
              const name = v(5);
              const code = v(14); // Index 14 = 'ico' column (v/t/x)
              
              if (!dateVal || !name || name === 'Nama' || !code) return; 

              let year, month, day;
              if (typeof dateVal === 'string' && dateVal.includes('-')) {
                  const parts = dateVal.split('-');
                  year = parseInt(parts[0]);
                  month = parseInt(parts[1]);
                  day = parseInt(parts[2]);
              } else if (String(dateVal).includes('Date')) {
                  const d = eval(`new ${dateVal}`);
                  year = d.getFullYear();
                  month = d.getMonth() + 1;
                  day = d.getDate();
              } else {
                  return;
              }

              if(!processedData[year]) processedData[year] = {};
              if(!processedData[year][month]) processedData[year][month] = {};
              if(!processedData[year][month][name]) processedData[year][month][name] = {};
              if(!processedData[year][month][name][day]) processedData[year][month][name][day] = { masuk: null, pulang: null };

              const dataObj = {
                  code: code,
                  time: v(3),
                  loc: v(9),
                  photo: v(10), // Isinya path text
                  jarak: v(11)
              };

              if(type === 'Masuk') processedData[year][month][name][day].masuk = dataObj;
              else processedData[year][month][name][day].pulang = dataObj;
          });
      }

      function populatePeriodFilters() {
          const years = Object.keys(processedData).sort((a,b) => b-a);
          availablePeriods = [];
          const selYear = document.getElementById('filter-year');
          const selMonth = document.getElementById('filter-month');
          selYear.innerHTML = ''; selMonth.innerHTML = '';

          if(years.length === 0) years.push(new Date().getFullYear());
          
          years.forEach(y => {
              const opt = document.createElement('option');
              opt.value = y; opt.text = y;
              selYear.appendChild(opt);
              if(processedData[y]) {
                  Object.keys(processedData[y]).forEach(m => availablePeriods.push({y:y, m:parseInt(m)}));
              }
          });
          availablePeriods.sort((a,b) => (b.y - a.y) || (b.m - a.m));
          
          const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
          monthNames.forEach((name, idx) => {
              const opt = document.createElement('option');
              opt.value = idx + 1; opt.text = name;
              selMonth.appendChild(opt);
          });
      }

      function renderDashboard() {
          const year = parseInt(document.getElementById('filter-year').value);
          const month = parseInt(document.getElementById('filter-month').value);
          const filterEmp = document.getElementById('filter-employee').value;

          const monthName = document.getElementById('filter-month').options[document.getElementById('filter-month').selectedIndex]?.text || '-';
          const badge = document.getElementById('current-period-badge');
          badge.textContent = `${monthName} ${year}`;
          badge.classList.remove('hidden');

          const gridData = [];
          const daysInMonth = new Date(year, month, 0).getDate();

          const allEmployees = [...rawData.masterEmp];
          if(processedData[year] && processedData[year][month]) {
              Object.keys(processedData[year][month]).forEach(n => {
                  if(!allEmployees.includes(n)) allEmployees.push(n);
              });
          }
          allEmployees.sort();

          const empSel = document.getElementById('filter-employee');
          if(empSel.options.length <= 1) {
              allEmployees.forEach(n => {
                   const opt = document.createElement('option');
                   opt.value = n; opt.text = n;
                   empSel.appendChild(opt);
              });
          }

          allEmployees.forEach(name => {
              if (filterEmp !== 'all' && name !== filterEmp) return;
              const empRow = { nama: name, days: [] };

              for(let d=1; d<=daysInMonth; d++) {
                  let dataHarian = { masuk: null, pulang: null };
                  if(processedData[year] && processedData[year][month] && processedData[year][month][name] && processedData[year][month][name][d]) {
                      dataHarian = processedData[year][month][name][d];
                  }

                  let mCode = dataHarian.masuk ? dataHarian.masuk.code : '';
                  let pCode = dataHarian.pulang ? dataHarian.pulang.code : '';

                  if(!mCode && !pCode) {
                      const checkDate = new Date(year, month-1, d);
                      const today = new Date();
                      if(checkDate < today) mCode = 'a';
                  }

                  empRow.days.push({
                      day: d,
                      masuk: { ...dataHarian.masuk, code: mCode },
                      pulang: { ...dataHarian.pulang, code: pCode }
                  });
              }
              gridData.push(empRow);
          });

          renderHeatmap(gridData, daysInMonth);
          calculateAndRenderStats(gridData, daysInMonth);
      }

      function renderHeatmap(data, daysCount) {
          const container = document.getElementById('heatmap-container');
          let html = '<table class="w-full border-collapse text-xs">';
          html += '<thead><tr class="bg-gray-50 border-b border-gray-200">';
          html += '<th class="p-3 text-left font-semibold text-gray-600 sticky left-0 bg-gray-50 z-20 shadow-sm min-w-[150px]">Nama Karyawan</th>';
          for(let i=1; i<=daysCount; i++) html += `<th colspan="2" class="p-1 text-center font-medium text-gray-400 border-l border-gray-100">${i}</th>`;
          html += '</tr></thead><tbody>';

          data.forEach(emp => {
              html += `<tr class="hover:bg-blue-50/30 border-b border-gray-100 transition-colors">`;
              html += `<td class="p-3 font-medium text-gray-700 sticky left-0 bg-white z-10 shadow-sm whitespace-nowrap">${emp.nama}</td>`;
              
              emp.days.forEach(d => {
                  const m = d.masuk; const cM = getStatusClass(m.code, 'Masuk');
                  const p = d.pulang; const cP = getStatusClass(p.code, 'Pulang', m.code);
                  
                  html += `<td class="p-1 border-l border-gray-100"><div onclick="openModal('${emp.nama}', ${d.day}, '${m.code||''}', 'Masuk', '${m.time||''}', '${m.loc||''}', '${m.photo||''}', '${m.jarak||''}')" class="heatmap-cell mx-auto ${cM}" title="Masuk: ${m.code || '-'}">${m.code ? m.code.toUpperCase() : ''}</div></td>`;
                  html += `<td class="p-1 border-r border-gray-100"><div onclick="openModal('${emp.nama}', ${d.day}, '${p.code||''}', 'Pulang', '${p.time||''}', '${p.loc||''}', '${p.photo||''}', '${p.jarak||''}')" class="heatmap-cell mx-auto ${cP}" title="Pulang: ${p.code || '-'}">${p.code === 'v' ? 'P' : (p.code ? p.code.toUpperCase() : '')}</div></td>`;
              });
              html += '</tr>';
          });
          html += '</tbody></table>';
          container.innerHTML = html;
      }

      function calculateAndRenderStats(data, daysCount) {
          let s = { hadir: 0, telat: 0, izin: 0, alpa: 0, dailyLate: Array(daysCount).fill(0) };
          let scores = [];

          data.forEach(emp => {
              let score = 0;
              emp.days.forEach((d, idx) => {
                  const c = d.masuk.code;
                  if(['v','x'].includes(c)) s.hadir++;
                  if(['t','tx'].includes(c)) { s.telat++; s.dailyLate[idx]++; }
                  if(['s','sx','i','ix'].includes(c)) s.izin++;
                  if(c === 'a') s.alpa++;

                  if(c === 'v') score += 10;
                  else if(c === 'x') score += 8;
                  else if(c === 't') score += 5;
                  else if(c === 'a') score -= 5;
              });
              scores.push({name: emp.nama, score: score});
          });

          document.getElementById('stat-hadir').innerText = s.hadir;
          document.getElementById('stat-telat').innerText = s.telat;
          document.getElementById('stat-izin').innerText = s.izin;
          document.getElementById('stat-alpa').innerText = s.alpa;

          renderLineChart(s.dailyLate, daysCount);

          scores.sort((a,b) => b.score - a.score);
          const list = document.getElementById('top-performer-list');
          list.innerHTML = scores.slice(0,5).map((x, i) => `
              <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100">
                  <div class="flex items-center gap-3"><span class="w-6 h-6 flex items-center justify-center ${i<3?'bg-yellow-500':'bg-gray-400'} text-white rounded-full text-xs font-bold shadow-sm">${i+1}</span><span class="font-medium text-gray-700">${x.name}</span></div>
                  <span class="text-sm font-bold text-blue-600">${x.score} Pts</span>
              </div>
          `).join('');
      }

      function getStatusClass(c, type, pairCode) {
          if(!c) {
              if(type === 'Pulang' && pairCode && pairCode !== 'a' && pairCode !== 'h') return 'status-lupa'; 
              return 'status-nodata';
          }
          c = c.toLowerCase();
          if(type === 'Pulang') {
              if(c === 'v') return 'status-pulang';
              if(c === 'a') return 'status-tidak-absen';
              return 'status-nodata';
          }
          if(c === 'v') return 'status-hadir';
          if(c === 'x') return 'status-hadir-salah-lokasi';
          if(c === 't') return 'status-telat';
          if(c === 'tx') return 'status-telat-salah-lokasi';
          if(c.startsWith('s')) return 'status-sakit';
          if(c.startsWith('i')) return 'status-izin';
          if(c === 'a') return 'status-tidak-absen';
          if(c === 'h') return 'status-libur';
          return 'status-nodata';
      }

      function renderLineChart(data, days) {
          const ctx = document.getElementById('chartLate').getContext('2d');
          if(charts.line) charts.line.destroy();
          charts.line = new Chart(ctx, {
              type: 'line',
              data: {
                  labels: Array.from({length:days}, (_,i)=>i+1),
                  datasets: [{ label: 'Jml Terlambat', data: data, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.4, pointRadius: 2 }]
              },
              options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
          });
      }

      window.openModal = function(nama, hari, code, type, jam, loc, foto, jarak) {
          const modal = document.getElementById('detailModal');
          const monthName = document.getElementById('filter-month').options[document.getElementById('filter-month').selectedIndex].text;
          const year = document.getElementById('filter-year').value;

          document.getElementById('modal-nama').innerText = nama;
          document.getElementById('modal-avatar').innerText = nama.charAt(0).toUpperCase();
          document.getElementById('modal-tanggal').innerText = `${hari} ${monthName} ${year}`;
          document.getElementById('modal-tipe').innerText = type.toUpperCase();
          document.getElementById('modal-status-badge').innerText = code ? `Kode: ${code.toUpperCase()}` : 'Tidak Ada Data';
          
          const elJam = document.getElementById('modal-jam');
          const elJarak = document.getElementById('modal-jarak');
          const elMaps = document.getElementById('modal-maps-link');
          const elFotoContainer = document.getElementById('modal-foto-container');
          const elFotoError = document.getElementById('modal-foto-error');
          const elImg = document.getElementById('modal-foto');
          const elNoData = document.getElementById('modal-no-data');

          const isValid = (val) => val && val !== 'null' && val !== 'undefined';
          const hasData = isValid(jam) || isValid(loc);

          if(hasData) {
              elNoData.classList.add('hidden');
              elJam.innerText = isValid(jam) ? jam.substring(0,5) : '--:--';
              elJarak.innerText = isValid(jarak) ? `${jarak} km` : '-';
              
              if(isValid(loc)) {
                  const cleanLoc = loc.replace(/["]/g, '');
                  elMaps.href = `https://www.google.com/maps/search/?api=1&query=${cleanLoc}`;
                  elMaps.classList.remove('hidden');
              } else {
                  elMaps.classList.add('hidden');
              }

              // Logic Image Display
              if(isValid(foto)) {
                  // Cek apakah ini URL (http) atau Path folder
                  if (foto.startsWith('http')) {
                       // Direct URL
                       elFotoContainer.classList.remove('hidden');
                       elFotoError.classList.add('hidden');
                       elImg.src = foto;
                  } else if (foto.includes('/') && !foto.startsWith('http')) {
                       // Ini kemungkinan Path Folder (Presensi Masuk_Images/...)
                       // Tidak bisa ditampilkan langsung
                       elFotoContainer.classList.add('hidden');
                       elFotoError.classList.remove('hidden');
                  } else {
                       // Kemungkinan Drive ID polos
                       elFotoContainer.classList.remove('hidden');
                       elFotoError.classList.add('hidden');
                       elImg.src = `https://drive.google.com/thumbnail?id=${foto}`;
                  }
              } else {
                  elFotoContainer.classList.add('hidden');
                  elFotoError.classList.add('hidden');
              }
          } else {
              elJam.innerText = '--:--'; elJarak.innerText = '-';
              elMaps.classList.add('hidden'); elFotoContainer.classList.add('hidden'); elFotoError.classList.add('hidden');
              elNoData.classList.remove('hidden');
          }
          modal.classList.remove('hidden');
      };

      window.closeModal = function() { document.getElementById('detailModal').classList.add('hidden'); };

      document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
