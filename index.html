<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Laporan Absensi</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Menggunakan font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* Custom scrollbar (optional, but nice) */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
        .kpi-card {
            transition: all 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        /* Gaya untuk status loading */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 1.2rem;
            color: #333;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Tambahkan overlay loading -->
    <div id="loadingOverlay">
        <p>Memuat data dashboard...</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Judul Dashboard -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Dashboard Laporan Absensi</h1>
            <p class="text-gray-600">Ringkasan kepatuhan dan tren kehadiran karyawan.</p>
        </header>

        <!-- Filter Kontrol -->
        <div class="mb-6 p-4 bg-white rounded-lg shadow-md">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Filter Tanggal Mulai -->
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                    <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- Filter Tanggal Selesai -->
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Selesai</label>
                    <input type="date" id="endDate" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- Filter Departemen -->
                <div>
                    <label for="filterDepartemen" class="block text-sm font-medium text-gray-700 mb-1">Departemen</label>
                    <select id="filterDepartemen" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="Semua">Semua Departemen</option>
                    </select>
                </div>
                <!-- Filter Karyawan -->
                <div>
                    <label for="filterKaryawan" class="block text-sm font-medium text-gray-700 mb-1">Karyawan</label>
                    <select id="filterKaryawan" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="Semua">Semua Karyawan</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 text-right">
                <button id="filterButton" class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50" disabled>
                    Terapkan Filter
                </button>
            </div>
        </div>

        <!-- KPI Utama -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
            <div class="kpi-card bg-white p-5 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-medium text-gray-500 uppercase">Tingkat Kehadiran</h3>
                <p id="kpi-tingkat-kehadiran" class="text-3xl font-bold text-blue-600 mt-2">0%</p>
            </div>
            <div class="kpi-card bg-white p-5 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-medium text-gray-500 uppercase">Total Hadir (Filter)</h3>
                <p id="kpi-total-hadir" class="text-3xl font-bold text-green-600 mt-2">0</p>
            </div>
            <div class="kpi-card bg-white p-5 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-medium text-gray-500 uppercase">Total Absen (Filter)</h3>
                <p id="kpi-total-absen" class="text-3xl font-bold text-red-600 mt-2">0</p>
            </div>
            <div class="kpi-card bg-white p-5 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-medium text-gray-500 uppercase">Total Terlambat (Filter)</h3>
                <p id="kpi-total-terlambat" class="text-3xl font-bold text-yellow-600 mt-2">0</p>
            </div>
            <div class="kpi-card bg-white p-5 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-medium text-gray-500 uppercase">Rata-Rata Jam Masuk</h3>
                <p id="kpi-avg-jam-masuk" class="text-3xl font-bold text-indigo-600 mt-2">--:--</p>
            </div>
        </div>

        <!-- Konten Dashboard (Grafik dan Tabel) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Kolom Kiri (Grafik) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Grafik Tren Kehadiran -->
                <div class="bg-white p-5 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Tren Kehadiran vs Absen (7 Hari Terakhir)</h2>
                    <canvas id="trenChart"></canvas>
                </div>
                
                <!-- Grafik Kepatuhan Departemen -->
                <div class="bg-white p-5 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Tingkat Kepatuhan per Departemen</h2>
                    <canvas id="deptChart"></canvas>
                </div>
            </div>

            <!-- Kolom Kanan (Tabel Real-time) -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Daftar Absen Hari Ini -->
                <div class="bg-white p-5 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Absen Hari Ini</h2>
                    <div id="table-absen-hari-ini" class="max-h-64 overflow-y-auto">
                        <!-- Tabel akan di-render oleh JS -->
                    </div>
                </div>

                <!-- Daftar Terlambat Hari Ini -->
                <div class="bg-white p-5 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Terlambat Hari Ini</h2>
                    <div id="table-terlambat-hari-ini" class="max-h-64 overflow-y-auto">
                        <!-- Tabel akan di-render oleh JS -->
                    </div>
                </div>
            </div>

            <!-- Analisis Performa Individu (Baris Baru) -->
            <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Tabel Karyawan Sering Terlambat -->
                <div class="bg-white p-5 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Karyawan Paling Sering Terlambat</h2>
                    <div id="table-top-terlambat" class="max-h-80 overflow-y-auto">
                        <!-- Tabel akan di-render oleh JS -->
                    </div>
                </div>

                <!-- Tabel Karyawan Sering Absen -->
                <div class="bg-white p-5 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Karyawan Paling Sering Absen</h2>
                    <div id="table-top-absen" class="max-h-80 overflow-y-auto">
                        <!-- Tabel akan di-render oleh JS -->
                    </div>
                </div>
            </div>

        </div> <!-- end grid konten -->
    </div> <!-- end container -->

    <script>
        // --- PENGATURAN KONEKSI GAS ---
        // URL Web App Anda telah dimasukkan
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyIgORJuY2bwgv7Q70qDEmSE2EFIiuZ3xBcs7d5lbyAjWABwVzBAjuqapxTU5qQ-n0kAg/exec'; 

        // --- Variabel Global untuk Data ---
        let allLaporanData = [];
        let allKaryawanList = [];
        let allDepartemenList = [];
        const today = new Date();
        const todayISO = formatISODate(today);


        // Variabel global untuk Chart
        let trenChartInstance = null;
        let deptChartInstance = null;
        
        // --- Fungsi Helper ---

        function formatISODate(date) {
            return date.toISOString().split('T')[0];
        }

        // --- Fungsi Rendering ---

        // Fungsi untuk merender tabel
        function renderTable(elementId, data, columns) {
            const container = document.getElementById(elementId);
            if (!data || data.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center py-4">Tidak ada data.</p>`;
                return;
            }

            let tableHTML = `<table class="w-full text-sm text-left text-gray-700">`;
            tableHTML += `<thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr>`;
            columns.forEach(col => {
                tableHTML += `<th scope="col" class="px-4 py-3">${col.header}</th>`;
            });
            tableHTML += `</tr></thead><tbody>`;

            data.forEach(item => {
                tableHTML += `<tr class="bg-white border-b hover:bg-gray-50">`;
                columns.forEach(col => {
                    tableHTML += `<td class="px-4 py-3">${item[col.key] || 'N/A'}</td>`;
                });
                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        // Fungsi untuk merender Grafik Tren
        function renderTrenChart(labels, dataHadir, dataAbsen) {
            const ctx = document.getElementById('trenChart').getContext('2d');
            if (trenChartInstance) {
                trenChartInstance.destroy();
            }
            trenChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Hadir',
                            data: dataHadir,
                            borderColor: 'rgb(34, 197, 94)', // green-500
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Absen',
                            data: dataAbsen,
                            borderColor: 'rgb(239, 68, 68)', // red-500
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Fungsi untuk merender Grafik Departemen
        function renderDeptChart(labels, data) {
            const ctx = document.getElementById('deptChart').getContext('2d');
            if (deptChartInstance) {
                deptChartInstance.destroy();
            }
            deptChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tingkat Kepatuhan (%)',
                        data: data,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.7)',
                            'rgba(16, 185, 129, 0.7)',
                            'rgba(234, 179, 8, 0.7)',
                            'rgba(249, 115, 22, 0.7)',
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y', // Membuatnya jadi horizontal bar chart
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Fungsi utama untuk update dashboard
        function updateDashboard() {
            // 1. Dapatkan nilai filter
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const departemen = document.getElementById('filterDepartemen').value;
            const karyawan = document.getElementById('filterKaryawan').value;

            // 2. Filter data utama (dari data global)
            let filteredData = allLaporanData.filter(item => {
                const tgl = item.tanggal;
                const isDateInRange = (!startDate || tgl >= startDate) && (!endDate || tgl <= endDate);
                const isDeptMatch = (departemen === 'Semua' || item.departemen === departemen);
                const isKaryawanMatch = (karyawan === 'Semua' || item.nama === karyawan);
                return isDateInRange && isDeptMatch && isKaryawanMatch;
            });

            // 3. Update KPI
            const totalHadir = filteredData.filter(d => d.status === 'Hadir').length;
            const totalAbsen = filteredData.filter(d => d.status === 'Absen').length;
            const totalTerlambat = filteredData.filter(d => d.keterangan && (d.keterangan.includes('Terlambat') || d.keterangan.includes('TELAT'))).length;
            
            // Perbaiki totalRecords agar berdasarkan karyawan unik x rentang hari (jika perlu)
            // Untuk kesederhanaan, kita gunakan total data terfilter
            const totalRecords = filteredData.length; 
            
            const tingkatKehadiran = totalRecords > 0 ? ((totalHadir / totalRecords) * 100).toFixed(1) : 0;
            
            let totalMenitMasuk = 0;
            let countMasuk = 0;
            filteredData.filter(d => d.jamMasuk).forEach(d => {
                const parts = String(d.jamMasuk).split(':');
                if (parts.length >= 2) {
                    totalMenitMasuk += (parseInt(parts[0]) * 60) + parseInt(parts[1]);
                    countMasuk++;
                }
            });
            let avgJamMasuk = '--:--';
            if (countMasuk > 0) {
                const avgMenit = totalMenitMasuk / countMasuk;
                const avgJam = Math.floor(avgMenit / 60);
                const avgMin = Math.round(avgMenit % 60);
                avgJamMasuk = `${String(avgJam).padStart(2, '0')}:${String(avgMin).padStart(2, '0')}`;
            }

            document.getElementById('kpi-tingkat-kehadiran').textContent = `${tingkatKehadiran}%`;
            document.getElementById('kpi-total-hadir').textContent = totalHadir;
            document.getElementById('kpi-total-absen').textContent = totalAbsen;
            document.getElementById('kpi-total-terlambat').textContent = totalTerlambat;
            document.getElementById('kpi-avg-jam-masuk').textContent = avgJamMasuk;


            // 4. Update Visualisasi Harian (Real-time, tidak terpengaruh filter tanggal)
            const dataHariIni = allLaporanData.filter(d => d.tanggal === todayISO);
            
            const absenHariIni = dataHariIni.filter(d => d.status === 'Absen');
            renderTable('table-absen-hari-ini', absenHariIni, [
                { header: 'Nama', key: 'nama' },
                { header: 'Departemen', key: 'departemen' }
            ]);

            const terlambatHariIni = dataHariIni.filter(d => d.keterangan && (d.keterangan.includes('Terlambat') || d.keterangan.includes('TELAT')));
            renderTable('table-terlambat-hari-ini', terlambatHariIni, [
                { header: 'Nama', key: 'nama' },
                { header: 'Jam Masuk', key: 'jamMasuk' }
            ]);
            

            // 5. Update Grafik Tren (7 Hari Terakhir)
            const trenData = {};
            for (let i = 6; i >= 0; i--) {
                let d = new Date(today);
                d.setDate(d.getDate() - i);
                let tglISO = formatISODate(d);
                
                const dataPerHari = allLaporanData.filter(item => item.tanggal === tglISO);
                trenData[tglISO] = {
                    hadir: dataPerHari.filter(item => item.status === 'Hadir').length,
                    absen: dataPerHari.filter(item => item.status === 'Absen').length
                };
            }
            const trenLabels = Object.keys(trenData);
            const dataHadir = trenLabels.map(tgl => trenData[tgl].hadir);
            const dataAbsen = trenLabels.map(tgl => trenData[tgl].absen);
            renderTrenChart(trenLabels, dataHadir, dataAbsen);

            
            // 6. Update Grafik Departemen (berdasarkan filter)
            const deptData = {};
            allDepartemenList.forEach(dept => {
                const dataPerDept = filteredData.filter(d => d.departemen === dept);
                const hadir = dataPerDept.filter(d => d.status === 'Hadir').length;
                const total = dataPerDept.length;
                deptData[dept] = total > 0 ? ((hadir / total) * 100).toFixed(1) : 0;
            });
            renderDeptChart(Object.keys(deptData), Object.values(deptData));
            

            // 7. Update Analisis Performa Individu (berdasarkan filter)
            const performa = {};
            allKaryawanList.forEach(k => performa[k.nama] = { nama: k.nama, departemen: k.departemen, terlambat: 0, absen: 0 });

            filteredData.forEach(item => {
                if(!performa[item.nama]) return; // Jaga-jaga jika data laporan tidak sinkron
                if (item.keterangan && (item.keterangan.includes('Terlambat') || item.keterangan.includes('TELAT'))) {
                    performa[item.nama].terlambat++;
                }
                if (item.status === 'Absen') {
                    performa[item.nama].absen++;
                }
            });

            const topTerlambat = Object.values(performa).sort((a, b) => b.terlambat - a.terlambat).filter(d => d.terlambat > 0);
            renderTable('table-top-terlambat', topTerlambat, [
                { header: 'Nama', key: 'nama' },
                { header: 'Departemen', key: 'departemen' },
                { header: 'Jumlah', key: 'terlambat' }
            ]);

            const topAbsen = Object.values(performa).sort((a, b) => b.absen - a.absen).filter(d => d.absen > 0);
            renderTable('table-top-absen', topAbsen, [
                { header: 'Nama', key: 'nama' },
                { header: 'Departemen', key: 'departemen' },
                { header: 'Jumlah', key: 'absen' }
            ]);
        }

        // Fungsi untuk mengisi filter dropdown
        function populateFilters() {
            const filterDept = document.getElementById('filterDepartemen');
            allDepartemenList.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                filterDept.appendChild(option);
            });

            const filterKaryawan = document.getElementById('filterKaryawan');
            allKaryawanList.forEach(k => {
                const option = document.createElement('option');
                option.value = k.nama;
                option.textContent = k.nama;
                filterKaryawan.appendChild(option);
            });
            
            // Set default tanggal filter (30 hari terakhir)
            const thirtyDaysAgo = new Date(new Date().setDate(today.getDate() - 30));
            document.getElementById('endDate').value = todayISO;
            document.getElementById('startDate').value = formatISODate(thirtyDaysAgo);
        }

        // --- Fungsi Utama untuk Inisialisasi ---
        async function initDashboard() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const filterButton = document.getElementById('filterButton');
            
            try {
                if (GAS_WEB_APP_URL === 'PASTE_URL_WEB_APP_ANDA_DI_SINI') {
                    loadingOverlay.textContent = 'Error: Harap masukkan URL Web App Google Apps Script di file HTML.';
                    return;
                }

                const response = await fetch(GAS_WEB_APP_URL);
                if (!response.ok) {
                    throw new Error(`Gagal mengambil data: ${response.statusText}`);
                }
                
                const data = await response.json();

                if (data.error) {
                     throw new Error(`Error dari Google Apps Script: ${data.error}`);
                }
                
                // Simpan data ke variabel global
                allLaporanData = data.laporanData;
                allKaryawanList = data.karyawanList;
                allDepartemenList = data.departemenList;

                // Isi filter
                populateFilters();
                
                // Tampilkan data awal
                updateDashboard(); 
                
                // Sembunyikan loading dan aktifkan filter
                loadingOverlay.style.display = 'none';
                filterButton.disabled = false;

            } catch (error) {
                console.error('Error saat inisialisasi dashboard:', error);
                loadingOverlay.textContent = `Error: ${error.message}. Cek konsol (F12) untuk detail.`;
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initDashboard(); // Panggil fungsi fetch data
        });

        document.getElementById('filterButton').addEventListener('click', updateDashboard);

    </script>
</body>
</html>

