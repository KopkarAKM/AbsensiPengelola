<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Absensi Karyawan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Gaya untuk Papan Skor Utama */
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* Gaya untuk Heatmap */
        .heatmap-cell {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .heatmap-cell:hover {
            transform: scale(1.2);
            z-index: 10;
        }
        .status-hadir { background-color: #10b981; } /* Hijau */
        .status-telat { background-color: #f59e0b; } /* Kuning */
        .status-sakit { background-color: #ef4444; } /* Merah */
        .status-izin { background-color: #8b5cf6; } /* Ungu */
        .status-absen { background-color: #6b7280; } /* Abu-abu */
        .status-kosong { background-color: #f3f4f6; } /* Abu-abu muda */

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full font-sans">
    
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loader"></div>
    </div>
    
    <!-- Konten Utama -->
    <div class="container mx-auto px-4 py-8">
        
        <!-- Header -->
        <header class="mb-6 md:mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Dashboard Absensi Karyawan</h1>
            <p class="text-gray-600 text-lg" id="periode-laporan">Memuat data...</p>
        </header>

        <!-- Filter -->
        <section class="mb-6 p-4 bg-white rounded-xl shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="filter-departemen" class="block text-sm font-medium text-gray-700 mb-1">Filter Departemen</label>
                    <select id="filter-departemen" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="semua">Semua Departemen</option>
                        <!-- Pilihan departemen akan diisi oleh JS -->
                    </select>
                </div>
                <div>
                    <label for="filter-karyawan" class="block text-sm font-medium text-gray-700 mb-1">Filter Karyawan</label>
                    <select id="filter-karyawan" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="semua">Semua Karyawan</option>
                        <!-- Pilihan karyawan akan diisi oleh JS -->
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="filter-button" class="w-full md:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition duration-300">Terapkan Filter</button>
                </div>
            </div>
        </section>

        <!-- Papan Skor Utama -->
        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìä Papan Skor Utama</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Tingkat Disiplin -->
                <div class="metric-card text-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">Tingkat Disiplin</p>
                            <p class="text-3xl font-bold" id="kpi-disiplin">0%</p>
                        </div>
                        <div class="text-4xl opacity-80">üéØ</div>
                    </div>
                </div>
                <!-- Total Keterlambatan -->
                <div class="metric-card text-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">Total Keterlambatan</p>
                            <p class="text-3xl font-bold" id="kpi-telat">0</p>
                        </div>
                        <div class="text-4xl opacity-80">‚è∞</div>
                    </div>
                </div>
                <!-- Total Absensi -->
                <div class="metric-card text-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">Total Absensi (Izin/Sakit/TA)</p>
                            <p class="text-3xl font-bold" id="kpi-absen">0</p>
                        </div>
                        <div class="text-4xl opacity-80">üìã</div>
                    </div>
                </div>
                <!-- Karyawan Paling Rawan -->
                <div class="metric-card text-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">Karyawan Paling Rawan</p>
                            <p class="text-xl font-bold" id="kpi-rawan">-</p>
                        </div>
                        <div class="text-4xl opacity-80">‚ö†Ô∏è</div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Grafik Tren -->
        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìà Grafik Tren</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Grafik Batang Keterlambatan -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Tren Keterlambatan Harian</h3>
                    <canvas id="chartKeterlambatan" height="200"></canvas>
                </div>
                <!-- Grafik Donat Komposisi -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Komposisi Absensi</h3>
                    <canvas id="chartKomposisi" height="200"></canvas>
                </div>
            </div>
        </section>

        <!-- Daftar Aksi -->
        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üéØ Daftar Aksi Prioritas</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Top 5 Keterlambatan -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="text-yellow-500 mr-2 text-xl">‚è∞</span>
                        Top 5 Keterlambatan
                    </h3>
                    <div class="space-y-3" id="top-keterlambatan">
                        <p class="text-gray-500">Tidak ada data.</p>
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
                <!-- Top 5 Absensi -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="text-red-500 mr-2 text-xl">üìã</span>
                        Top 5 Absensi (Izin/Sakit/TA)
                    </h3>
                    <div class="space-y-3" id="top-absensi">
                        <p class="text-gray-500">Tidak ada data.</p>
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Peta Panas Kinerja -->
        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üî• Peta Panas Kinerja</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                <div class="mb-4 flex flex-wrap gap-x-4 gap-y-2 text-sm">
                    <div class="flex items-center"><div class="w-4 h-4 status-hadir rounded mr-2"></div><span>Hadir</span></div>
                    <div class="flex items-center"><div class="w-4 h-4 status-telat rounded mr-2"></div><span>Telat</span></div>
                    <div class="flex items-center"><div class="w-4 h-4 status-sakit rounded mr-2"></div><span>Sakit</span></div>
                    <div class="flex items-center"><div class="w-4 h-4 status-izin rounded mr-2"></div><span>Izin</span></div>
                    <div class="flex items-center"><div class="w-4 h-4 status-absen rounded mr-2"></div><span>Tidak Absen</span></div>
                    <div class="flex items-center"><div class="w-4 h-4 status-kosong rounded mr-2 border"></div><span>Kosong</span></div>
                </div>
                <div id="heatmap-container" class="overflow-x-auto">
                    <p class="text-gray-500">Pilih filter untuk menampilkan data heatmap.</p>
                    <!-- Heatmap akan diisi oleh JavaScript -->
                </div>
            </div>
        </section>

    </div>

    <script>
        // --- KONFIGURASI ---
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyIgORJuY2bwgv7Q70qDEmSE2EFIiuZ3xBcs7d5lbyAjWABwVzBAjuqapxTU5qQ-n0kAg/exec";

        // --- VARIABEL GLOBAL ---
        let globalLaporanData = [];
        let globalKaryawanList = [];
        let chartKeterlambatan = null;
        let chartKomposisi = null;

        // --- ELEMEN DOM ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const periodeLaporanEl = document.getElementById('periode-laporan');
        const filterDepartemenEl = document.getElementById('filter-departemen');
        const filterKaryawanEl = document.getElementById('filter-karyawan');
        const filterButton = document.getElementById('filter-button');

        // --- FUNGSI UTAMA ---

        /**
         * Inisialisasi Dashboard
         * Mengambil data dari Google Apps Script dan memuat filter awal.
         */
        async function initDashboard() {
            loadingOverlay.style.opacity = '1';
            
            // Tambahkan "cache buster" untuk selalu mendapat data baru
            const url = `${GAS_WEB_APP_URL}?v=${new Date().getTime()}`;
            
            let data; // Deklarasi data di luar try-catch

            // --- PERBAIKAN: TRY-CATCH YANG LEBIH ROBUST ---
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    // Tangani jika server GAS error (500, 404, dll)
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                data = await response.json();
                
                // Cek jika GAS mengirim balik data error yang kita buat (dari blok catch di GAS)
                if (data.periode && data.periode.startsWith("Error:")) {
                    throw new Error(data.periode);
                }
                
                // Cek jika data yang diterima kosong (ini bukan error, tapi perlu ditangani)
                if (!data.karyawanList || !data.laporanData) {
                    throw new Error("Struktur data tidak valid dari server.");
                }

            } catch (error) {
                console.error("Gagal mengambil data:", error);
                periodeLaporanEl.textContent = `Gagal memuat data: ${error.message}`;
                periodeLaporanEl.classList.add('text-red-600');
                loadingOverlay.style.opacity = '0'; // Sembunyikan loader
                loadingOverlay.style.pointerEvents = 'none';
                
                // Hentikan eksekusi jika fetch gagal
                return; 
            }
            // --- AKHIR PERBAIKAN ---

            // Jika berhasil, 'data' dijamin valid dan berisi array
            globalLaporanData = data.laporanData;
            globalKaryawanList = data.karyawanList;
            
            // Set judul periode
            periodeLaporanEl.textContent = `Laporan untuk periode: ${data.periode || 'Bulan Ini'}`;
            
            // Muat filter
            populateFilter(globalKaryawanList);
            
            // Tambahkan event listener ke filter
            filterButton.addEventListener('click', updateDashboard);
            
            // Tampilkan data awal (semua karyawan)
            updateDashboard();
            
            // Sembunyikan loader
            loadingOverlay.style.opacity = '0';
            loadingOverlay.style.pointerEvents = 'none';
        }

        /**
         * Memuat pilihan filter berdasarkan daftar karyawan.
         */
        function populateFilter(karyawanList) {
            // Filter Departemen
            const departemenSet = new Set(karyawanList.map(k => k.departemen));
            departemenSet.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                filterDepartemenEl.appendChild(option);
            });

            // Filter Karyawan
            karyawanList.forEach(k => {
                const option = document.createElement('option');
                option.value = k.id;
                option.textContent = k.nama;
                filterKaryawanEl.appendChild(option);
            });
        }

        /**
         * Memperbarui semua komponen dashboard berdasarkan filter yang dipilih.
         */
        function updateDashboard() {
            const idKaryawan = filterKaryawanEl.value;
            const departemen = filterDepartemenEl.value;

            // Tentukan data yang akan di-render
            let filteredData = globalLaporanData;

            if (idKaryawan !== 'semua') {
                filteredData = globalLaporanData.filter(d => d.id === idKaryawan);
            } else if (departemen !== 'semua') {
                filteredData = globalLaporanData.filter(d => d.departemen === departemen);
            }
            
            // Tentukan daftar karyawan yang akan di-render di heatmap
            let filteredKaryawanList = globalKaryawanList;
            if (idKaryawan !== 'semua') {
                filteredKaryawanList = globalKaryawanList.filter(k => k.id === idKaryawan);
            } else if (departemen !== 'semua') {
                filteredKaryawanList = globalKaryawanList.filter(k => k.departemen === departemen);
            }

            // Update semua komponen
            updateKPI(filteredData);
            updateChartKeterlambatan(filteredData);
            updateChartKomposisi(filteredData);
            updateTopLists(filteredData);
            updateHeatmap(filteredData, filteredKaryawanList);
        }

        /**
         * Update 4 Kartu Papan Skor Utama (KPI).
         */
        function updateKPI(data) {
            const totalHadirTepatWaktu = data.filter(d => d.status === 'Hadir' && d.keterangan === 'Tepat Waktu').length;
            const totalTelat = data.filter(d => d.status === 'Hadir' && d.keterangan === 'Terlambat').length;
            const totalSakit = data.filter(d => d.status === 'Sakit').length;
            const totalIzin = data.filter(d => d.status === 'Izin').length;
            const totalTidakAbsen = data.filter(d => d.status === 'Absen' && d.keterangan === 'Tidak Absen').length;

            const totalAbsensi = totalSakit + totalIzin + totalTidakAbsen;
            const totalKehadiran = totalHadirTepatWaktu + totalTelat;

            // 1. Tingkat Disiplin
            let disiplin = 0;
            if (totalKehadiran > 0) {
                disiplin = Math.round((totalHadirTepatWaktu / totalKehadiran) * 100);
            }
            document.getElementById('kpi-disiplin').textContent = `${disiplin}%`;

            // 2. Total Keterlambatan
            document.getElementById('kpi-telat').textContent = totalTelat;
            
            // 3. Total Absensi
            document.getElementById('kpi-absen').textContent = totalAbsensi;

            // 4. Karyawan Paling Rawan
            document.getElementById('kpi-rawan').textContent = getKaryawanRawan(data);
        }

        /**
         * Mencari karyawan dengan jumlah (Telat + Absen) terbanyak.
         */
        function getKaryawanRawan(data) {
            const stats = {};
            data.forEach(d => {
                if (d.status !== 'Hadir' || d.keterangan === 'Terlambat') {
                    if (!stats[d.nama]) stats[d.nama] = 0;
                    stats[d.nama]++;
                }
            });

            let maxCount = 0;
            let namaRawan = '-';
            for (const nama in stats) {
                if (stats[nama] > maxCount) {
                    maxCount = stats[nama];
                    namaRawan = nama;
                }
            }
            return namaRawan;
        }

        /**
         * Update Grafik Batang (Bar) Tren Keterlambatan Harian.
         */
        function updateChartKeterlambatan(data) {
            const telatPerHari = {};
            // Inisialisasi 31 hari
            for (let i = 1; i <= 31; i++) {
                telatPerHari[i] = 0;
            }
            
            data.forEach(d => {
                if (d.status === 'Hadir' && d.keterangan === 'Terlambat') {
                    const hari = new Date(d.tanggal).getUTCDate(); // Gunakan UTC agar konsisten
                    if (!telatPerHari[hari]) telatPerHari[hari] = 0;
                    telatPerHari[hari]++;
                }
            });

            // Ambil data hari yang ada isinya saja
            const labels = Object.keys(telatPerHari).filter(day => telatPerHari[day] > 0);
            const values = labels.map(day => telatPerHari[day]);

            const ctx = document.getElementById('chartKeterlambatan').getContext('2d');
            if (chartKeterlambatan) {
                chartKeterlambatan.destroy();
            }
            chartKeterlambatan = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Keterlambatan',
                        data: values,
                        backgroundColor: 'rgba(245, 158, 11, 0.8)', // Oranye
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        /**
         * Update Grafik Donat (Doughnut) Komposisi Absensi.
         */
        function updateChartKomposisi(data) {
            const totalSakit = data.filter(d => d.status === 'Sakit').length;
            const totalIzin = data.filter(d => d.status === 'Izin').length;
            const totalTidakAbsen = data.filter(d => d.status === 'Absen' && d.keterangan === 'Tidak Absen').length;
            
            const total = totalSakit + totalIzin + totalTidakAbsen;
            
            const ctx = document.getElementById('chartKomposisi').getContext('2d');
            if (chartKomposisi) {
                chartKomposisi.destroy();
            }
            
            // Tampilkan pesan jika tidak ada data
            if (total === 0) {
                 ctx.font = "16px Arial";
                 ctx.fillStyle = "#9ca3af";
                 ctx.textAlign = "center";
                 ctx.fillText("Tidak ada data absensi", ctx.canvas.width / 2, ctx.canvas.height / 2);
                 return;
            }
            
            chartKomposisi = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Sakit', 'Izin', 'Tidak Absen (TA)'],
                    datasets: [{
                        data: [totalSakit, totalIzin, totalTidakAbsen],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',  // Merah
                            'rgba(139, 92, 246, 0.8)', // Ungu
                            'rgba(107, 114, 128, 0.8)' // Abu-abu
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        /**
         * Update daftar Top 5 Keterlambatan dan Absensi.
         */
        function updateTopLists(data) {
            const statsTelat = {};
            const statsAbsen = {};

            data.forEach(d => {
                const nama = d.nama;
                if (d.status === 'Hadir' && d.keterangan === 'Terlambat') {
                    if (!statsTelat[nama]) statsTelat[nama] = 0;
                    statsTelat[nama]++;
                }
                if (d.status === 'Sakit' || d.status === 'Izin' || (d.status === 'Absen' && d.keterangan === 'Tidak Absen')) {
                    if (!statsAbsen[nama]) statsAbsen[nama] = 0;
                    statsAbsen[nama]++;
                }
            });

            // Konversi ke array, urutkan, dan ambil top 5
            const sortedTelat = Object.entries(statsTelat).sort(([, a], [, b]) => b - a).slice(0, 5);
            const sortedAbsen = Object.entries(statsAbsen).sort(([, a], [, b]) => b - a).slice(0, 5);

            // Render Top 5 Keterlambatan
            const containerTelat = document.getElementById('top-keterlambatan');
            containerTelat.innerHTML = '';
            if (sortedTelat.length === 0) {
                containerTelat.innerHTML = '<p class="text-gray-500">Tidak ada data keterlambatan.</p>';
            } else {
                sortedTelat.forEach(([nama, jumlah], index) => {
                    containerTelat.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                            <div class="flex items-center">
                                <span class="w-6 h-6 bg-yellow-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">${index + 1}</span>
                                <span class="font-medium text-gray-800">${nama}</span>
                            </div>
                            <span class="text-yellow-600 font-bold">${jumlah}x</span>
                        </div>
                    `;
                });
            }

            // Render Top 5 Absensi
            const containerAbsen = document.getElementById('top-absensi');
            containerAbsen.innerHTML = '';
            if (sortedAbsen.length === 0) {
                containerAbsen.innerHTML = '<p class="text-gray-500">Tidak ada data absensi.</p>';
            } else {
                sortedAbsen.forEach(([nama, jumlah], index) => {
                    containerAbsen.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                            <div class="flex items-center">
                                <span class="w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">${index + 1}</span>
                                <span class="font-medium text-gray-800">${nama}</span>
                            </div>
                            <span class="text-red-600 font-bold">${jumlah}x</span>
                        </div>
                    `;
                });
            }
        }
        
        /**
         * Update Peta Panas (Heatmap) Kinerja Karyawan.
         */
        function updateHeatmap(data, karyawanList) {
            const container = document.getElementById('heatmap-container');
            container.innerHTML = ''; // Kosongkan
            
            if (karyawanList.length === 0) {
                 container.innerHTML = '<p class="text-gray-500">Tidak ada data karyawan untuk ditampilkan.</p>';
                 return;
            }

            // Cari tahu hari apa saja yang ada di data (1-31)
            const daysSet = new Set();
            data.forEach(d => {
                daysSet.add(new Date(d.tanggal).getUTCDate());
            });
            // Jika tidak ada data sama sekali, tampilkan 31 hari
            if (daysSet.size === 0) {
                for(let i=1; i<=31; i++) daysSet.add(i);
            }
            const days = Array.from(daysSet).sort((a, b) => a - b);


            // Buat Map data untuk pencarian cepat: dataMap['id_karyawan']['hari'] = 'status'
            const dataMap = {};
            data.forEach(d => {
                const hari = new Date(d.tanggal).getUTCDate();
                if (!dataMap[d.id]) dataMap[d.id] = {};
                
                let statusKelas = 'status-kosong';
                if (d.status === 'Hadir' && d.keterangan === 'Tepat Waktu') statusKelas = 'status-hadir';
                else if (d.status === 'Hadir' && d.keterangan === 'Terlambat') statusKelas = 'status-telat';
                else if (d.status === 'Sakit') statusKelas = 'status-sakit';
                else if (d.status === 'Izin') statusKelas = 'status-izin';
                else if (d.status === 'Absen' && d.keterangan === 'Tidak Absen') statusKelas = 'status-absen';
                
                dataMap[d.id][hari] = statusKelas;
            });

            // Buat tabel heatmap
            const table = document.createElement('table');
            table.className = 'min-w-full';
            
            // Header (Tanggal)
            let headerHTML = '<thead><tr><th class="sticky left-0 bg-white p-2 text-left text-sm font-semibold text-gray-700 min-w-[150px]">Karyawan</th>';
            days.forEach(day => {
                headerHTML += `<th class="p-1 text-center text-xs text-gray-600 font-medium w-8">${String(day).padStart(2, '0')}</th>`;
            });
            headerHTML += '</tr></thead>';
            table.innerHTML += headerHTML;

            // Body (Karyawan)
            let bodyHTML = '<tbody>';
            karyawanList.forEach(karyawan => {
                bodyHTML += '<tr class="border-t border-gray-200">';
                bodyHTML += `<td class="sticky left-0 bg-white p-2 text-sm font-medium text-gray-800 whitespace-nowrap">${karyawan.nama}</td>`;
                
                days.forEach(day => {
                    const statusKelas = dataMap[karyawan.id] ? (dataMap[karyawan.id][day] || 'status-kosong') : 'status-kosong';
                    const title = `${karyawan.nama} - Hari ${day}: ${statusKelas.split('-')[1] || 'Kosong'}`;
                    
                    bodyHTML += `
                        <td class="p-1">
                            <div class="heatmap-cell mx-auto ${statusKelas}" title="${title}"></div>
                        </td>
                    `;
                });
                bodyHTML += '</tr>';
            });
            bodyHTML += '</tbody>';
            table.innerHTML += bodyHTML;

            container.appendChild(table);
        }

        // --- INISIALISASI ---
        document.addEventListener('DOMContentLoaded', initDashboard);

    </script>
</body>
</html>

