<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- Memuat Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- MEMUAT CHART.JS UNTUK GRAFIK -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6; /* Latar belakang abu-abu muda */
    }
    /* Animasi loader */
    .loader {
      border: 4px solid #f3f3ff; /* Warna loader lebih terang */
      border-top: 4px solid #4f46e5; /* Warna indigo */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Styling untuk sticky header tabel heatmap */
    #table-container thead th {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    /* Styling untuk sticky column tabel heatmap */
    #table-container tbody td:nth-child(1),
    #table-container thead th:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 20;
    }
    #table-container tbody td:nth-child(2),
    #table-container thead th:nth-child(2) {
      position: sticky;
      left: 150px; /* Sesuaikan dengan lebar kolom Nama */
      z-index: 20;
    }
    #table-container tbody td:nth-child(1),
    #table-container tbody td:nth-child(2) {
      background-color: white; /* Pastikan background sticky column */
    }
  </style>
</head>
<body class="p-4 md:p-8">

  <!-- Loader Utama Saat Memuat -->
  <div id="main-loader" class="flex flex-col justify-center items-center h-screen">
    <div class="loader"></div>
    <p class="mt-4 text-gray-600">Menganalisis data kehadiran...</p>
  </div>

  <!-- Konten Utama (Tersembunyi saat memuat) -->
  <div id="main-content" class="max-w-7xl mx-auto space-y-8 hidden">
  
    <!-- Header -->
    <div class="bg-white p-6 rounded-lg shadow-lg">
      <h1 class="text-3xl font-bold text-gray-800">Dasbor Wawasan Manajerial</h1>
      <p class="text-gray-600">Ringkasan Kinerja Kehadiran Koperasi (Bulan Ini)</p>
    </div>

    <!-- Kontainer untuk Scorecard/KPI -->
    <div id="kpi-container" class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <!-- KPI akan diisi oleh JavaScript -->
    </div>

    <!-- Kontainer Grafik -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Tren Keterlambatan Harian</h2>
        <div class="h-64 md:h-80">
          <canvas id="lateTrendChart"></canvas>
        </div>
      </div>
      <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Komposisi Ketidakhadiran</h2>
        <div class="h-64 md:h-80 flex items-center justify-center">
          <canvas id="absenceChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Kontainer Daftar Aksi (Top 5) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Daftar Aksi: Keterlambatan Terbanyak</h2>
        <div class="overflow-y-auto max-h-64">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Jumlah Telat</th>
              </tr>
            </thead>
            <tbody id="top-late-table" class="bg-white divide-y divide-gray-200">
              <!-- Diisi oleh JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Daftar Aksi: Absensi Terbanyak</h2>
        <div class="overflow-y-auto max-h-64">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Jumlah Absen (S+I+TA)</th>
              </tr>
            </thead>
            <tbody id="top-absent-table" class="bg-white divide-y divide-gray-200">
              <!-- Diisi oleh JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Kontainer untuk tabel data (Heatmap) -->
    <div class="bg-white p-6 rounded-lg shadow-lg">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Peta Panas (Heatmap) Laporan Bulanan</h2>
      <div id="table-container" class="overflow-x-auto max-h-96">
        <table id="attendance-table" class="min-w-full">
          <thead class="bg-gray-100">
            <tr id="table-header">
              <!-- Header diisi oleh JavaScript -->
            </tr>
          </thead>
          <tbody id="table-body" class="bg-white divide-y divide-gray-200">
            <!-- Body diisi oleh JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
    
  </div> <!-- Akhir dari main-content -->

  <script>
    // Panggil fungsi Apps Script saat halaman dimuat
    document.addEventListener('DOMContentLoaded', function() {
      google.script.run
        .withSuccessHandler(buildDashboard)
        .withFailureHandler(showError)
        .getAttendanceData();
    });

    function showError(error) {
      console.error(error);
      const loader = document.getElementById('main-loader');
      loader.innerHTML = 
        `<div class="max-w-lg mx-auto bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
           <strong class="font-bold">Gagal memuat data!</strong>
           <span class="block sm:inline">Penyebab: ${error.message || JSON.stringify(error)}</span>
           <p class="mt-2 text-xs">Pastikan Anda telah menekan 'Deploy' > 'Deployment baru' setelah menyimpan kode, dan telah 'Mengizinkan akses' (Allow access) pada akun Google Anda.</p>
           <p class="mt-1 text-xs">Cek juga apakah nama sheet sudah benar 'Laporan' dan format header tanggal (1-31) sudah ada.</p>
         </div>`;
    }

    // Fungsi untuk membangun dasbor setelah data diterima
    function buildDashboard(response) {
      if (response.error) {
        showError(response);
        return;
      }

      // Bangun setiap bagian
      buildKPIs(response.kpis);
      buildCharts(response.charts);
      buildTopLists(response.topLists);
      buildTable(response.heatmap.headers, response.heatmap.employees);
      
      // Hapus loader dan tampilkan konten
      document.getElementById('main-loader').remove();
      document.getElementById('main-content').classList.remove('hidden');
    }
    
    // Fungsi untuk membuat Scorecard KPI
    function buildKPIs(kpis) {
      const kpiContainer = document.getElementById('kpi-container');
      kpiContainer.innerHTML = `
        <div class="bg-indigo-50 border border-indigo-200 p-4 rounded-lg shadow">
          <h3 class="text-sm font-medium text-indigo-600">Tingkat Disiplin</h3>
          <p class="text-3xl font-bold text-indigo-900">${kpis.disciplineRate}</p>
        </div>
        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg shadow">
          <h3 class="text-sm font-medium text-yellow-600">Total Keterlambatan</h3>
          <p class="text-3xl font-bold text-yellow-900">${kpis.totalLate}</p>
        </div>
        <div class="bg-red-50 border border-red-200 p-4 rounded-lg shadow">
          <h3 class="text-sm font-medium text-red-600">Total Ketidakhadiran</h3>
          <p class="text-3xl font-bold text-red-900">${kpis.totalAbsent}</p>
        </div>
        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg shadow">
          <h3 class="text-sm font-medium text-blue-600">Total Karyawan</h3>
          <p class="text-3xl font-bold text-blue-900">${kpis.totalEmployees}</p>
        </div>
      `;
    }
    
    // Fungsi untuk membuat Grafik
    function buildCharts(charts) {
      // 1. Grafik Batang Tren Telat
      const ctxLate = document.getElementById('lateTrendChart').getContext('2d');
      new Chart(ctxLate, {
        type: 'bar',
        data: {
          labels: charts.dailyLate.labels,
          datasets: [{
            label: 'Jumlah Terlambat',
            data: charts.dailyLate.data,
            backgroundColor: 'rgba(239, 68, 68, 0.6)', // red
            borderColor: 'rgba(239, 68, 68, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
          },
          plugins: { legend: { display: false } }
        }
      });

      // 2. Grafik Donat Komposisi Absen
      const ctxAbsence = document.getElementById('absenceChart').getContext('2d');
      new Chart(ctxAbsence, {
        type: 'doughnut',
        data: {
          labels: charts.absenceComp.labels,
          datasets: [{
            label: 'Jumlah',
            data: charts.absenceComp.data,
            backgroundColor: [
              'rgba(245, 158, 11, 0.7)', // yellow
              'rgba(59, 130, 246, 0.7)', // blue
              'rgba(239, 68, 68, 0.7)',  // red
              'rgba(107, 114, 128, 0.7)' // gray
            ],
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }
    
    // Fungsi untuk membuat Tabel Top 5
    function buildTopLists(lists) {
      const lateTable = document.getElementById('top-late-table');
      const absentTable = document.getElementById('top-absent-table');
      
      if (lists.topLate.length === 0 || lists.topLate.every(item => item.late === 0)) {
        lateTable.innerHTML = '<tr><td colspan="2" class="px-4 py-3 text-sm text-gray-500 text-center">Tidak ada data keterlambatan.</td></tr>';
      } else {
        lists.topLate.forEach(item => {
          if (item.late > 0) { // Hanya tampilkan jika ada data
            lateTable.innerHTML += `
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-2 text-sm font-medium text-gray-900">${item.name}</td>
                <td class="px-4 py-2 text-sm text-gray-700 text-center font-bold">${item.late}</td>
              </tr>`;
          }
        });
      }
      
      if (lists.topAbsent.length === 0 || lists.topAbsent.every(item => item.absent === 0)) {
        absentTable.innerHTML = '<tr><td colspan="2" class="px-4 py-3 text-sm text-gray-500 text-center">Tidak ada data absensi.</td></tr>';
      } else {
        lists.topAbsent.forEach(item => {
          if (item.absent > 0) { // Hanya tampilkan jika ada data
            absentTable.innerHTML += `
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-2 text-sm font-medium text-gray-900">${item.name}</td>
                <td class="px-4 py-2 text-sm text-gray-700 text-center font-bold">${item.absent}</td>
              </tr>`;
          }
        });
      }
    }

    // Fungsi untuk membuat tabel detail (Heatmap)
    function buildTable(headers, employees) {
      const tableHeader = document.getElementById('table-header');
      const tableBody = document.getElementById('table-body');
      
      // Buat Header Tabel
      headers.forEach((header, index) => {
        const th = document.createElement('th');
        th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-100';
        // Terapkan sticky untuk 2 kolom pertama
        if (index === 0) {
          th.style.width = '150px'; // Lebar kolom Nama
        }
        if (index === 1) {
          th.style.width = '100px'; // Lebar kolom ID
        }
        th.textContent = header;
        tableHeader.appendChild(th);
      });

      // Buat Baris Data Karyawan
      employees.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach((cell, index) => {
          const td = document.createElement('td');
          td.className = 'px-4 py-3 whitespace-nowrap text-sm';

          // Terapkan styling bersyarat (conditional formatting)
          if (cell === 'v') {
            td.className += ' bg-green-50 text-green-800 text-center font-semibold';
          } else if (cell === 'T') {
            td.className += ' bg-yellow-50 text-yellow-800 text-center font-semibold';
          } else if (['S', 'I', 'TA', 'x'].includes(cell)) {
            td.className += ' bg-red-50 text-red-800 text-center font-semibold';
          } else {
            td.className += ' text-gray-700';
          }
          
          // Terapkan sticky untuk 2 kolom pertama
          if (index === 0) {
            td.classList.add('font-medium', 'text-gray-900');
          }
          if (index === 1) {
             td.classList.add('text-gray-500');
          }
          
          td.textContent = cell;
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
      });
    }

  </script>
</body>
</html>

